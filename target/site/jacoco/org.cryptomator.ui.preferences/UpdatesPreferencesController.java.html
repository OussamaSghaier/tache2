<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UpdatesPreferencesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.preferences</a> &gt; <span class="el_source">UpdatesPreferencesController.java</span></div><h1>UpdatesPreferencesController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.preferences;

import org.cryptomator.common.Environment;
import org.cryptomator.common.settings.Settings;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.fxapp.UpdateChecker;

import javax.inject.Inject;
import javafx.animation.PauseTransition;
import javafx.application.Application;
import javafx.beans.binding.Bindings;
import javafx.beans.binding.BooleanBinding;
import javafx.beans.binding.ObjectBinding;
import javafx.beans.binding.StringBinding;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.ReadOnlyStringProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.value.ObservableValue;
import javafx.fxml.FXML;
import javafx.scene.control.CheckBox;
import javafx.scene.control.ContentDisplay;
import java.time.Duration;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.time.format.FormatStyle;
import java.util.Locale;
import java.util.ResourceBundle;


@PreferencesScoped
public class UpdatesPreferencesController implements FxController {

	private static final String DOWNLOADS_URI = &quot;https://cryptomator.org/downloads&quot;;

	private final Application application;
	private final Environment environment;
	private final ResourceBundle resourceBundle;
	private final Settings settings;
	private final UpdateChecker updateChecker;
	private final ObjectBinding&lt;ContentDisplay&gt; checkForUpdatesButtonState;
	private final ReadOnlyStringProperty latestVersion;
	private final ObservableValue&lt;Instant&gt; lastSuccessfulUpdateCheck;
	private final StringBinding lastUpdateCheckMessage;
	private final ObservableValue&lt;String&gt; timeDifferenceMessage;
	private final String currentVersion;
	private final BooleanBinding updateAvailable;
	private final BooleanBinding checkFailed;
<span class="nc" id="L50">	private final BooleanProperty upToDateLabelVisible = new SimpleBooleanProperty(false);</span>
	private final DateTimeFormatter formatter;
	private final BooleanBinding upToDate;

	/* FXML */
	public CheckBox checkForUpdatesCheckbox;

	@Inject
<span class="nc" id="L58">	UpdatesPreferencesController(Application application, Environment environment, ResourceBundle resourceBundle, Settings settings, UpdateChecker updateChecker) {</span>
<span class="nc" id="L59">		this.application = application;</span>
<span class="nc" id="L60">		this.environment = environment;</span>
<span class="nc" id="L61">		this.resourceBundle = resourceBundle;</span>
<span class="nc" id="L62">		this.settings = settings;</span>
<span class="nc" id="L63">		this.updateChecker = updateChecker;</span>
<span class="nc" id="L64">		this.checkForUpdatesButtonState = Bindings.when(updateChecker.checkingForUpdatesProperty()).then(ContentDisplay.LEFT).otherwise(ContentDisplay.TEXT_ONLY);</span>
<span class="nc" id="L65">		this.latestVersion = updateChecker.latestVersionProperty();</span>
<span class="nc" id="L66">		this.lastSuccessfulUpdateCheck = updateChecker.lastSuccessfulUpdateCheckProperty();</span>
<span class="nc" id="L67">		this.timeDifferenceMessage = Bindings.createStringBinding(this::getTimeDifferenceMessage, lastSuccessfulUpdateCheck);</span>
<span class="nc" id="L68">		this.currentVersion = updateChecker.getCurrentVersion();</span>
<span class="nc" id="L69">		this.updateAvailable = updateChecker.updateAvailableProperty();</span>
<span class="nc" id="L70">		this.formatter = DateTimeFormatter.ofLocalizedDateTime(FormatStyle.MEDIUM).withLocale(Locale.getDefault());</span>
<span class="nc" id="L71">		this.upToDate = updateChecker.updateCheckStateProperty().isEqualTo(UpdateChecker.UpdateCheckState.CHECK_SUCCESSFUL).and(latestVersion.isEqualTo(currentVersion));</span>
<span class="nc" id="L72">		this.checkFailed = updateChecker.checkFailedProperty();</span>
<span class="nc" id="L73">		this.lastUpdateCheckMessage = Bindings.createStringBinding(this::getLastUpdateCheckMessage, lastSuccessfulUpdateCheck);</span>
<span class="nc" id="L74">	}</span>

	public void initialize() {
<span class="nc" id="L77">		checkForUpdatesCheckbox.selectedProperty().bindBidirectional(settings.checkForUpdates);</span>

<span class="nc" id="L79">		upToDate.addListener((_, _, newVal) -&gt; {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">			if (newVal) {</span>
<span class="nc" id="L81">				upToDateLabelVisible.set(true);</span>
<span class="nc" id="L82">				PauseTransition delay = new PauseTransition(javafx.util.Duration.seconds(5));</span>
<span class="nc" id="L83">				delay.setOnFinished(_ -&gt; upToDateLabelVisible.set(false));</span>
<span class="nc" id="L84">				delay.play();</span>
			}
<span class="nc" id="L86">		});</span>
<span class="nc" id="L87">	}</span>

	@FXML
	public void checkNow() {
<span class="nc" id="L91">		updateChecker.checkForUpdatesNow();</span>
<span class="nc" id="L92">	}</span>

	@FXML
	public void visitDownloadsPage() {
<span class="nc" id="L96">		application.getHostServices().showDocument(DOWNLOADS_URI);</span>
<span class="nc" id="L97">	}</span>

	@FXML
	public void showLogfileDirectory() {
<span class="nc" id="L101">		environment.getLogDir().ifPresent(logDirPath -&gt; application.getHostServices().showDocument(logDirPath.toUri().toString()));</span>
<span class="nc" id="L102">	}</span>

	/* Observable Properties */

	public ObjectBinding&lt;ContentDisplay&gt; checkForUpdatesButtonStateProperty() {
<span class="nc" id="L107">		return checkForUpdatesButtonState;</span>
	}

	public ContentDisplay getCheckForUpdatesButtonState() {
<span class="nc" id="L111">		return checkForUpdatesButtonState.get();</span>
	}

	public ReadOnlyStringProperty latestVersionProperty() {
<span class="nc" id="L115">		return latestVersion;</span>
	}

	public String getLatestVersion() {
<span class="nc" id="L119">		return latestVersion.get();</span>
	}

	public String getCurrentVersion() {
<span class="nc" id="L123">		return currentVersion;</span>
	}

	public StringBinding lastUpdateCheckMessageProperty() {
<span class="nc" id="L127">		return lastUpdateCheckMessage;</span>
	}

	public String getLastUpdateCheckMessage() {
<span class="nc" id="L131">		Instant lastCheck = lastSuccessfulUpdateCheck.getValue();</span>
<span class="nc bnc" id="L132" title="All 4 branches missed.">		if (lastCheck != null &amp;&amp; !lastCheck.equals(Settings.DEFAULT_TIMESTAMP)) {</span>
<span class="nc" id="L133">			return formatter.format(LocalDateTime.ofInstant(lastCheck, ZoneId.systemDefault()));</span>
		} else {
<span class="nc" id="L135">			return &quot;-&quot;;</span>
		}
	}

	public ObservableValue&lt;String&gt; timeDifferenceMessageProperty() {
<span class="nc" id="L140">		return timeDifferenceMessage;</span>
	}

	public String getTimeDifferenceMessage() {
<span class="nc" id="L144">		var lastSuccessCheck = lastSuccessfulUpdateCheck.getValue();</span>
<span class="nc" id="L145">		var duration = Duration.between(lastSuccessCheck, Instant.now());</span>
<span class="nc" id="L146">		var hours = duration.toHours();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		if (lastSuccessCheck.equals(Settings.DEFAULT_TIMESTAMP)) {</span>
<span class="nc" id="L148">			return resourceBundle.getString(&quot;preferences.updates.lastUpdateCheck.never&quot;);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">		} else if (hours &lt; 1) {</span>
<span class="nc" id="L150">			return resourceBundle.getString(&quot;preferences.updates.lastUpdateCheck.recently&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">		} else if (hours &lt; 24) {</span>
<span class="nc" id="L152">			return String.format(resourceBundle.getString(&quot;preferences.updates.lastUpdateCheck.hoursAgo&quot;), hours);</span>
		} else {
<span class="nc" id="L154">			return String.format(resourceBundle.getString(&quot;preferences.updates.lastUpdateCheck.daysAgo&quot;), duration.toDays());</span>
		}
	}

	public BooleanProperty upToDateLabelVisibleProperty() {
<span class="nc" id="L159">		return upToDateLabelVisible;</span>
	}

	public boolean isUpToDateLabelVisible() {
<span class="nc" id="L163">		return upToDateLabelVisible.get();</span>
	}

	public BooleanBinding updateAvailableProperty() {
<span class="nc" id="L167">		return updateAvailable;</span>
	}

	public boolean isUpdateAvailable() {
<span class="nc" id="L171">		return updateAvailable.get();</span>
	}

	public BooleanBinding checkFailedProperty() {
<span class="nc" id="L175">		return checkFailed;</span>
	}

	public boolean isCheckFailed() {
<span class="nc" id="L179">		return checkFailed.getValue();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>