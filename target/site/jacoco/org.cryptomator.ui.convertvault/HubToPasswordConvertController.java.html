<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HubToPasswordConvertController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.convertvault</a> &gt; <span class="el_source">HubToPasswordConvertController.java</span></div><h1>HubToPasswordConvertController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.convertvault;

import com.google.common.base.Preconditions;
import dagger.Lazy;
import org.cryptomator.common.Constants;
import org.cryptomator.common.Passphrase;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.cryptofs.VaultConfig;
import org.cryptomator.cryptofs.VaultVersionMismatchException;
import org.cryptomator.cryptofs.common.BackupHelper;
import org.cryptomator.cryptolib.api.MasterkeyLoadingFailedException;
import org.cryptomator.cryptolib.common.MasterkeyFileAccess;
import org.cryptomator.ui.changepassword.NewPasswordController;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.common.FxmlFile;
import org.cryptomator.ui.common.FxmlScene;
import org.cryptomator.ui.fxapp.FxApplicationWindows;
import org.cryptomator.ui.recoverykey.RecoveryKeyFactory;
import org.jetbrains.annotations.VisibleForTesting;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javafx.application.Platform;
import javafx.beans.binding.Bindings;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.property.StringProperty;
import javafx.fxml.FXML;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.ContentDisplay;
import javafx.stage.Stage;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardCopyOption;
import java.util.ResourceBundle;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionException;
import java.util.concurrent.ExecutorService;

import static java.nio.file.StandardOpenOption.CREATE_NEW;
import static java.nio.file.StandardOpenOption.WRITE;
import static org.cryptomator.common.Constants.MASTERKEY_BACKUP_SUFFIX;
import static org.cryptomator.common.Constants.MASTERKEY_FILENAME;
import static org.cryptomator.common.Constants.VAULTCONFIG_FILENAME;

public class HubToPasswordConvertController implements FxController {

<span class="fc" id="L52">	private static final Logger LOG = LoggerFactory.getLogger(HubToPasswordConvertController.class);</span>

	private final Stage window;
	private final Lazy&lt;Scene&gt; successScene;
	private final FxApplicationWindows applicationWindows;
	private final Vault vault;
	private final StringProperty recoveryKey;
	private final RecoveryKeyFactory recoveryKeyFactory;
	private final MasterkeyFileAccess masterkeyFileAccess;
	private final ExecutorService backgroundExecutorService;
	private final ResourceBundle resourceBundle;
	private final BooleanProperty conversionStarted;

	@FXML
	NewPasswordController newPasswordController;
	public Button convertBtn;

	@Inject
<span class="fc" id="L70">	public HubToPasswordConvertController(@ConvertVaultWindow Stage window, @FxmlScene(FxmlFile.CONVERTVAULT_HUBTOPASSWORD_SUCCESS) Lazy&lt;Scene&gt; successScene, FxApplicationWindows applicationWindows, @ConvertVaultWindow Vault vault, @ConvertVaultWindow StringProperty recoveryKey, RecoveryKeyFactory recoveryKeyFactory, MasterkeyFileAccess masterkeyFileAccess, ExecutorService backgroundExecutorService, ResourceBundle resourceBundle) {</span>
<span class="fc" id="L71">		this.window = window;</span>
<span class="fc" id="L72">		this.successScene = successScene;</span>
<span class="fc" id="L73">		this.applicationWindows = applicationWindows;</span>
<span class="fc" id="L74">		this.vault = vault;</span>
<span class="fc" id="L75">		this.recoveryKey = recoveryKey;</span>
<span class="fc" id="L76">		this.recoveryKeyFactory = recoveryKeyFactory;</span>
<span class="fc" id="L77">		this.masterkeyFileAccess = masterkeyFileAccess;</span>
<span class="fc" id="L78">		this.backgroundExecutorService = backgroundExecutorService;</span>
<span class="fc" id="L79">		this.resourceBundle = resourceBundle;</span>
<span class="fc" id="L80">		this.conversionStarted = new SimpleBooleanProperty(false);</span>

<span class="fc" id="L82">	}</span>

	@FXML
	public void initialize() {
<span class="nc" id="L86">		convertBtn.disableProperty().bind(Bindings.createBooleanBinding( //</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">				() -&gt; !newPasswordController.isGoodPassword() || conversionStarted.get(), //</span>
<span class="nc" id="L88">				newPasswordController.goodPasswordProperty(), //</span>
				conversionStarted));
<span class="nc" id="L90">		convertBtn.contentDisplayProperty().bind(Bindings.createObjectBinding( //</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">				() -&gt; conversionStarted.getValue() ? ContentDisplay.LEFT : ContentDisplay.TEXT_ONLY, //</span>
				conversionStarted));
<span class="nc" id="L93">		convertBtn.textProperty().bind(Bindings.createStringBinding( //</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">				() -&gt; resourceBundle.getString(&quot;convertVault.convert.convertBtn.&quot; + (conversionStarted.get() ? &quot;processing&quot; : &quot;before&quot;)), //</span>
				conversionStarted));
<span class="nc" id="L96">	}</span>

	@FXML
	public void close() {
<span class="nc" id="L100">		window.close();</span>
<span class="nc" id="L101">	}</span>

	@FXML
	public void convert() {
<span class="nc" id="L105">		Preconditions.checkState(newPasswordController.isGoodPassword());</span>
<span class="nc" id="L106">		LOG.info(&quot;Converting access method of vault {} from hub to password&quot;, vault.getPath());</span>
<span class="nc" id="L107">		CompletableFuture.runAsync(() -&gt; conversionStarted.setValue(true), Platform::runLater) //</span>
<span class="nc" id="L108">				.thenRunAsync(this::convertInternal, backgroundExecutorService) //</span>
<span class="nc" id="L109">				.whenCompleteAsync((result, exception) -&gt; {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">					if (exception == null) {</span>
<span class="nc" id="L111">						LOG.info(&quot;Conversion of vault {} succeeded.&quot;, vault.getPath());</span>
<span class="nc" id="L112">						window.setScene(successScene.get());</span>
					} else {
<span class="nc" id="L114">						LOG.error(&quot;Conversion of vault {} failed.&quot;, vault.getPath(), exception);</span>
<span class="nc" id="L115">						applicationWindows.showErrorWindow(exception, window, null);</span>
					}
<span class="nc" id="L117">				}, Platform::runLater); //</span>
<span class="nc" id="L118">	}</span>

	@VisibleForTesting
	void convertInternal() throws CompletionException, IllegalArgumentException {
<span class="fc" id="L122">		var passphrase = newPasswordController.getNewPassword();</span>
<span class="fc" id="L123">		var vaultPath = vault.getPath();</span>
		try {
			//create masterkey
<span class="fc" id="L126">			recoveryKeyFactory.newMasterkeyFileWithPassphrase(vaultPath, recoveryKey.get(), passphrase);</span>
<span class="fc" id="L127">			LOG.debug(&quot;Successfully created masterkey file for vault {}&quot;, vaultPath);</span>
			//create password config
<span class="fc" id="L129">			Path passwordConfigPath = vaultPath.resolve(&quot;passwordBased.&quot; + VAULTCONFIG_FILENAME + &quot;.tmp&quot;);</span>
<span class="fc" id="L130">			passwordConfigPath = createPasswordConfig(passwordConfigPath, vaultPath.resolve(MASTERKEY_FILENAME), passphrase);</span>
			//backup hub config
<span class="fc" id="L132">			var hubConfigPath = vaultPath.resolve(VAULTCONFIG_FILENAME);</span>
<span class="fc" id="L133">			backupHubConfig(hubConfigPath);</span>
			//replace hub by password
<span class="fc" id="L135">			Files.move(passwordConfigPath, hubConfigPath, StandardCopyOption.REPLACE_EXISTING, StandardCopyOption.ATOMIC_MOVE);</span>
<span class="fc" id="L136">		} catch (MasterkeyLoadingFailedException e) {</span>
<span class="fc" id="L137">			throw new CompletionException(new IOException(&quot;Vault conversion failed&quot;, e));</span>
<span class="fc" id="L138">		} catch (IOException e) {</span>
<span class="fc" id="L139">			throw new CompletionException(&quot;Vault conversion failed&quot;, e);</span>
		} finally {
<span class="fc" id="L141">			passphrase.destroy();</span>
		}
<span class="fc" id="L143">	}</span>

	@VisibleForTesting
	void backupHubConfig(Path hubConfigPath) throws IOException {
<span class="fc" id="L147">		byte[] hubConfigBytes = Files.readAllBytes(hubConfigPath);</span>
<span class="fc" id="L148">		Path backupPath = hubConfigPath.resolveSibling(VAULTCONFIG_FILENAME + BackupHelper.generateFileIdSuffix(hubConfigBytes) + MASTERKEY_BACKUP_SUFFIX);</span>
<span class="fc" id="L149">		Files.copy(hubConfigPath, backupPath, StandardCopyOption.REPLACE_EXISTING);</span>
<span class="fc" id="L150">		LOG.debug(&quot;Successfully created hub config backup {}&quot;, backupPath.getFileName());</span>
<span class="fc" id="L151">	}</span>

	@VisibleForTesting
	Path createPasswordConfig(Path passwordConfigPath, Path masterkeyFile, Passphrase passphrase) throws IOException, MasterkeyLoadingFailedException {
<span class="fc" id="L155">		var unverifiedVaultConfig = vault.getVaultConfigCache().get();</span>
<span class="fc" id="L156">		try (var masterkey = masterkeyFileAccess.load(masterkeyFile, passphrase)) {</span>
<span class="fc" id="L157">			var hubConfig = unverifiedVaultConfig.verify(masterkey.getEncoded(), unverifiedVaultConfig.allegedVaultVersion());</span>
<span class="fc" id="L158">			var passwordConfig = VaultConfig.createNew() //</span>
<span class="fc" id="L159">					.cipherCombo(hubConfig.getCipherCombo()) //</span>
<span class="fc" id="L160">					.shorteningThreshold(hubConfig.getShorteningThreshold()) //</span>
<span class="fc" id="L161">					.build();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">			if (passwordConfig.getVaultVersion() != hubConfig.getVaultVersion()) {</span>
<span class="nc" id="L163">				throw new VaultVersionMismatchException(&quot;Only vaults of version &quot; + passwordConfig.getVaultVersion() + &quot; can be converted.&quot;);</span>
			}
<span class="fc" id="L165">			var token = passwordConfig.toToken(Constants.DEFAULT_KEY_ID.toString(), masterkey.getEncoded());</span>
<span class="fc" id="L166">			Files.writeString(passwordConfigPath, token, StandardCharsets.US_ASCII, WRITE, CREATE_NEW);</span>
<span class="fc" id="L167">			LOG.debug(&quot;Successfully created password config {}&quot;, passwordConfigPath);</span>
<span class="fc" id="L168">			return passwordConfigPath;</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>