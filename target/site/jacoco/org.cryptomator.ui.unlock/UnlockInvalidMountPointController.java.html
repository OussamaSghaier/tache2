<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UnlockInvalidMountPointController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.unlock</a> &gt; <span class="el_source">UnlockInvalidMountPointController.java</span></div><h1>UnlockInvalidMountPointController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.unlock;

import org.cryptomator.common.ObservableUtil;
import org.cryptomator.common.mount.HideawayNotDirectoryException;
import org.cryptomator.common.mount.IllegalMountPointException;
import org.cryptomator.common.mount.MountPointCleanupFailedException;
import org.cryptomator.common.mount.MountPointInUseException;
import org.cryptomator.common.mount.MountPointNotEmptyDirectoryException;
import org.cryptomator.common.mount.MountPointNotExistingException;
import org.cryptomator.common.mount.MountPointNotSupportedException;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.controls.FormattedLabel;
import org.cryptomator.ui.fxapp.FxApplicationWindows;
import org.cryptomator.ui.preferences.SelectedPreferencesTab;
import org.cryptomator.ui.vaultoptions.SelectedVaultOptionsTab;
import org.jetbrains.annotations.PropertyKey;

import javax.inject.Inject;
import javafx.beans.property.ObjectProperty;
import javafx.beans.value.ObservableValue;
import javafx.fxml.FXML;
import javafx.stage.Stage;
import java.nio.file.Path;
import java.util.ResourceBundle;

//At the current point in time only the CustomMountPointChooser may cause this window to be shown.
@UnlockScoped
public class UnlockInvalidMountPointController implements FxController {

	private final Stage window;
	private final Vault vault;
	private final FxApplicationWindows appWindows;

	private final ObservableValue&lt;ExceptionType&gt; exceptionType;
	private final ObservableValue&lt;Path&gt; exceptionPath;
	private final ObservableValue&lt;String&gt; exceptionMessage;
	private final ObservableValue&lt;Path&gt; hideawayPath;
	private final ObservableValue&lt;String&gt; format;
	private final ObservableValue&lt;Boolean&gt; showPreferences;
	private final ObservableValue&lt;Boolean&gt; showVaultOptions;

	public FormattedLabel dialogDescription;

	@Inject
<span class="nc" id="L46">	UnlockInvalidMountPointController(@UnlockWindow Stage window, @UnlockWindow Vault vault, @UnlockWindow ObjectProperty&lt;IllegalMountPointException&gt; illegalMountPointException, FxApplicationWindows appWindows, ResourceBundle resourceBundle) {</span>
<span class="nc" id="L47">		this.window = window;</span>
<span class="nc" id="L48">		this.vault = vault;</span>
<span class="nc" id="L49">		this.appWindows = appWindows;</span>

<span class="nc" id="L51">		this.exceptionType = illegalMountPointException.map(this::getExceptionType);</span>
<span class="nc" id="L52">		this.exceptionPath = illegalMountPointException.map(IllegalMountPointException::getMountpoint);</span>
<span class="nc" id="L53">		this.exceptionMessage = illegalMountPointException.map(IllegalMountPointException::getMessage);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">		this.hideawayPath = illegalMountPointException.map(e -&gt; e instanceof HideawayNotDirectoryException haeExc ? haeExc.getHideaway() : null);</span>

<span class="nc" id="L56">		this.format = ObservableUtil.mapWithDefault(exceptionType, type -&gt; resourceBundle.getString(type.translationKey), &quot;&quot;);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">		this.showPreferences = ObservableUtil.mapWithDefault(exceptionType, type -&gt; type.action == ButtonAction.SHOW_PREFERENCES, false);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">		this.showVaultOptions = ObservableUtil.mapWithDefault(exceptionType, type -&gt; type.action == ButtonAction.SHOW_VAULT_OPTIONS, false);</span>
<span class="nc" id="L59">	}</span>

	@FXML
	public void close() {
<span class="nc" id="L63">		window.close();</span>
<span class="nc" id="L64">	}</span>

	@FXML
	public void closeAndOpenPreferences() {
<span class="nc" id="L68">		appWindows.showPreferencesWindow(SelectedPreferencesTab.VOLUME);</span>
<span class="nc" id="L69">		window.close();</span>
<span class="nc" id="L70">	}</span>

	@FXML
	public void closeAndOpenVaultOptions() {
<span class="nc" id="L74">		appWindows.showVaultOptionsWindow(vault, SelectedVaultOptionsTab.MOUNT);</span>
<span class="nc" id="L75">		window.close();</span>
<span class="nc" id="L76">	}</span>

	private ExceptionType getExceptionType(Throwable unlockException) {
<span class="nc bnc" id="L79" title="All 7 branches missed.">		return switch (unlockException) {</span>
<span class="nc" id="L80">			case MountPointNotSupportedException x -&gt; ExceptionType.NOT_SUPPORTED;</span>
<span class="nc" id="L81">			case MountPointNotExistingException x -&gt; ExceptionType.NOT_EXISTING;</span>
<span class="nc" id="L82">			case MountPointInUseException x -&gt; ExceptionType.IN_USE;</span>
<span class="nc" id="L83">			case HideawayNotDirectoryException x -&gt; ExceptionType.HIDEAWAY_NOT_DIR;</span>
<span class="nc" id="L84">			case MountPointCleanupFailedException x -&gt; ExceptionType.COULD_NOT_BE_CLEARED;</span>
<span class="nc" id="L85">			case MountPointNotEmptyDirectoryException x -&gt; ExceptionType.NOT_EMPTY_DIRECTORY;</span>
<span class="nc" id="L86">			default -&gt; ExceptionType.GENERIC;</span>
		};
	}

<span class="nc" id="L90">	private enum ExceptionType {</span>

<span class="nc" id="L92">		NOT_SUPPORTED(&quot;unlock.error.customPath.description.notSupported&quot;, ButtonAction.SHOW_PREFERENCES),</span>
<span class="nc" id="L93">		NOT_EXISTING(&quot;unlock.error.customPath.description.notExists&quot;, ButtonAction.SHOW_VAULT_OPTIONS),</span>
<span class="nc" id="L94">		IN_USE(&quot;unlock.error.customPath.description.inUse&quot;, ButtonAction.SHOW_VAULT_OPTIONS),</span>
<span class="nc" id="L95">		HIDEAWAY_NOT_DIR(&quot;unlock.error.customPath.description.hideawayNotDir&quot;, ButtonAction.SHOW_VAULT_OPTIONS),</span>
<span class="nc" id="L96">		COULD_NOT_BE_CLEARED(&quot;unlock.error.customPath.description.couldNotBeCleaned&quot;, ButtonAction.SHOW_VAULT_OPTIONS),</span>
<span class="nc" id="L97">		NOT_EMPTY_DIRECTORY(&quot;unlock.error.customPath.description.notEmptyDir&quot;, ButtonAction.SHOW_VAULT_OPTIONS),</span>
<span class="nc" id="L98">		GENERIC(&quot;unlock.error.customPath.description.generic&quot;, ButtonAction.SHOW_PREFERENCES);</span>

		private final String translationKey;
		private final ButtonAction action;

<span class="nc" id="L103">		ExceptionType(@PropertyKey(resourceBundle = &quot;i18n.strings&quot;) String translationKey, ButtonAction action) {</span>
<span class="nc" id="L104">			this.translationKey = translationKey;</span>
<span class="nc" id="L105">			this.action = action;</span>
<span class="nc" id="L106">		}</span>
	}

<span class="nc" id="L109">	private enum ButtonAction {</span>

		//TODO Add option to show filesystem, e.g. for ExceptionType.HIDEAWAY_EXISTS
<span class="nc" id="L112">		SHOW_PREFERENCES,</span>
<span class="nc" id="L113">		SHOW_VAULT_OPTIONS;</span>

	}

	/* Getter */

	public Path getExceptionPath() {
<span class="nc" id="L120">		return exceptionPath.getValue();</span>
	}

	public ObservableValue&lt;Path&gt; exceptionPathProperty() {
<span class="nc" id="L124">		return exceptionPath;</span>
	}

	public String getFormat() {
<span class="nc" id="L128">		return format.getValue();</span>
	}

	public ObservableValue&lt;String&gt; formatProperty() {
<span class="nc" id="L132">		return format;</span>
	}

	public String getExceptionMessage() {
<span class="nc" id="L136">		return exceptionMessage.getValue();</span>
	}

	public ObservableValue&lt;String&gt; exceptionMessageProperty() {
<span class="nc" id="L140">		return exceptionMessage;</span>
	}

	public Path getHideawayPath() {
<span class="nc" id="L144">		return hideawayPath.getValue();</span>
	}

	public ObservableValue&lt;Path&gt; hideawayPathProperty() {
<span class="nc" id="L148">		return hideawayPath;</span>
	}

	public Boolean getShowPreferences() {
<span class="nc" id="L152">		return showPreferences.getValue();</span>
	}

	public ObservableValue&lt;Boolean&gt; showPreferencesProperty() {
<span class="nc" id="L156">		return showPreferences;</span>
	}

	public Boolean getShowVaultOptions() {
<span class="nc" id="L160">		return showVaultOptions.getValue();</span>
	}

	public ObservableValue&lt;Boolean&gt; showVaultOptionsProperty() {
<span class="nc" id="L164">		return showVaultOptions;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>