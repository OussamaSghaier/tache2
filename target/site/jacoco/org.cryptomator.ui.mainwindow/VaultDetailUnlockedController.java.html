<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VaultDetailUnlockedController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.mainwindow</a> &gt; <span class="el_source">VaultDetailUnlockedController.java</span></div><h1>VaultDetailUnlockedController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.mainwindow;

import com.google.common.base.Preconditions;
import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.tobiasdiez.easybind.EasyBind;
import org.apache.commons.lang3.SystemUtils;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.integrations.mount.Mountpoint;
import org.cryptomator.integrations.revealpath.RevealFailedException;
import org.cryptomator.integrations.revealpath.RevealPathService;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.common.VaultService;
import org.cryptomator.ui.fxapp.FxApplicationWindows;
import org.cryptomator.ui.stats.VaultStatisticsComponent;
import org.cryptomator.ui.wrongfilealert.WrongFileAlertComponent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javafx.application.Platform;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.ObjectProperty;
import javafx.beans.property.ReadOnlyObjectProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.value.ObservableValue;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.input.Clipboard;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.DataFormat;
import javafx.scene.input.DragEvent;
import javafx.scene.input.TransferMode;
import javafx.stage.FileChooser;
import javafx.stage.Stage;
import java.io.File;
import java.io.IOException;
import java.nio.file.Path;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.ResourceBundle;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;

@MainWindowScoped
public class VaultDetailUnlockedController implements FxController {

<span class="nc" id="L50">	private static final Logger LOG = LoggerFactory.getLogger(VaultDetailUnlockedController.class);</span>
	private static final String ACTIVE_CLASS = &quot;active&quot;;

	private final ReadOnlyObjectProperty&lt;Vault&gt; vault;
	private final FxApplicationWindows appWindows;
	private final VaultService vaultService;
	private final WrongFileAlertComponent.Builder wrongFileAlert;
	private final Stage mainWindow;
	private final Optional&lt;RevealPathService&gt; revealPathService;
	private final ResourceBundle resourceBundle;
	private final LoadingCache&lt;Vault, VaultStatisticsComponent&gt; vaultStats;
	private final VaultStatisticsComponent.Builder vaultStatsBuilder;
	private final ObservableValue&lt;Boolean&gt; accessibleViaPath;
	private final ObservableValue&lt;Boolean&gt; accessibleViaUri;
	private final ObservableValue&lt;String&gt; mountPoint;
<span class="nc" id="L65">	private final BooleanProperty draggingOver = new SimpleBooleanProperty();</span>
<span class="nc" id="L66">	private final BooleanProperty ciphertextPathsCopied = new SimpleBooleanProperty();</span>

	//FXML
	public Button dropZone;

	@Inject
<span class="nc" id="L72">	public VaultDetailUnlockedController(ObjectProperty&lt;Vault&gt; vault, FxApplicationWindows appWindows, VaultService vaultService, VaultStatisticsComponent.Builder vaultStatsBuilder, WrongFileAlertComponent.Builder wrongFileAlert, @MainWindow Stage mainWindow, Optional&lt;RevealPathService&gt; revealPathService, ResourceBundle resourceBundle) {</span>
<span class="nc" id="L73">		this.vault = vault;</span>
<span class="nc" id="L74">		this.appWindows = appWindows;</span>
<span class="nc" id="L75">		this.vaultService = vaultService;</span>
<span class="nc" id="L76">		this.wrongFileAlert = wrongFileAlert;</span>
<span class="nc" id="L77">		this.mainWindow = mainWindow;</span>
<span class="nc" id="L78">		this.revealPathService = revealPathService;</span>
<span class="nc" id="L79">		this.resourceBundle = resourceBundle;</span>
<span class="nc" id="L80">		this.vaultStats = CacheBuilder.newBuilder().weakValues().build(CacheLoader.from(this::buildVaultStats));</span>
<span class="nc" id="L81">		this.vaultStatsBuilder = vaultStatsBuilder;</span>
<span class="nc" id="L82">		var mp = vault.flatMap(Vault::mountPointProperty);</span>
<span class="nc" id="L83">		this.accessibleViaPath = mp.map(m -&gt; m instanceof Mountpoint.WithPath).orElse(false);</span>
<span class="nc" id="L84">		this.accessibleViaUri = mp.map(m -&gt; m instanceof Mountpoint.WithUri).orElse(false);</span>
<span class="nc" id="L85">		this.mountPoint = mp.map(m -&gt; {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">			if (m instanceof Mountpoint.WithPath mwp) {</span>
<span class="nc" id="L87">				return mwp.path().toString();</span>
			} else {
<span class="nc" id="L89">				return m.uri().toASCIIString();</span>
			}
		});
<span class="nc" id="L92">	}</span>

	public void initialize() {
<span class="nc" id="L95">		dropZone.setOnDragEntered(this::handleDragEvent);</span>
<span class="nc" id="L96">		dropZone.setOnDragOver(this::handleDragEvent);</span>
<span class="nc" id="L97">		dropZone.setOnDragDropped(this::handleDragEvent);</span>
<span class="nc" id="L98">		dropZone.setOnDragExited(this::handleDragEvent);</span>

<span class="nc" id="L100">		EasyBind.includeWhen(dropZone.getStyleClass(), ACTIVE_CLASS, draggingOver);</span>
<span class="nc" id="L101">	}</span>

	private void handleDragEvent(DragEvent event) {
<span class="nc bnc" id="L104" title="All 6 branches missed.">		if (DragEvent.DRAG_OVER.equals(event.getEventType()) &amp;&amp; event.getGestureSource() == null &amp;&amp; event.getDragboard().hasFiles()) {</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">			if(SystemUtils.IS_OS_WINDOWS || SystemUtils.IS_OS_MAC) {</span>
<span class="nc" id="L106">				event.acceptTransferModes(TransferMode.LINK);</span>
			} else {
<span class="nc" id="L108">				event.acceptTransferModes(TransferMode.ANY);</span>
			}
<span class="nc" id="L110">			draggingOver.set(true);</span>
<span class="nc bnc" id="L111" title="All 6 branches missed.">		} else if (DragEvent.DRAG_DROPPED.equals(event.getEventType()) &amp;&amp; event.getGestureSource() == null &amp;&amp; event.getDragboard().hasFiles()) {</span>
<span class="nc" id="L112">			List&lt;Path&gt; ciphertextPaths = event.getDragboard().getFiles().stream().map(File::toPath).map(this::getCiphertextPath).flatMap(Optional::stream).toList();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">			if (ciphertextPaths.isEmpty()) {</span>
<span class="nc" id="L114">				wrongFileAlert.build().showWrongFileAlertWindow();</span>
			} else {
<span class="nc" id="L116">				revealOrCopyPaths(ciphertextPaths);</span>
			}
<span class="nc bnc" id="L118" title="All 2 branches missed.">			event.setDropCompleted(!ciphertextPaths.isEmpty());</span>
<span class="nc" id="L119">			event.consume();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		} else if (DragEvent.DRAG_EXITED.equals(event.getEventType())) {</span>
<span class="nc" id="L121">			draggingOver.set(false);</span>
		}
<span class="nc" id="L123">	}</span>

	private VaultStatisticsComponent buildVaultStats(Vault vault) {
<span class="nc" id="L126">		return vaultStatsBuilder.vault(vault).build();</span>
	}

	@FXML
	public void revealAccessLocation() {
<span class="nc" id="L131">		vaultService.reveal(vault.get());</span>
<span class="nc" id="L132">	}</span>

	@FXML
	public void copyMountUri() {
<span class="nc" id="L136">		ClipboardContent clipboardContent = new ClipboardContent();</span>
<span class="nc" id="L137">		clipboardContent.putString(mountPoint.getValue());</span>
<span class="nc" id="L138">		Clipboard.getSystemClipboard().setContent(clipboardContent);</span>
<span class="nc" id="L139">	}</span>

	@FXML
	public void lock() {
<span class="nc" id="L143">		appWindows.startLockWorkflow(vault.get(), mainWindow);</span>
<span class="nc" id="L144">	}</span>

	@FXML
	public void showVaultStatistics() {
<span class="nc" id="L148">		vaultStats.getUnchecked(vault.get()).showVaultStatisticsWindow();</span>
<span class="nc" id="L149">	}</span>

	@FXML
	public void chooseFileAndReveal() {
<span class="nc" id="L153">		Preconditions.checkState(accessibleViaPath.getValue());</span>
<span class="nc" id="L154">		var fileChooser = new FileChooser();</span>
<span class="nc" id="L155">		fileChooser.setTitle(resourceBundle.getString(&quot;main.vaultDetail.filePickerTitle&quot;));</span>
<span class="nc" id="L156">		fileChooser.setInitialDirectory(Path.of(mountPoint.getValue()).toFile());</span>
<span class="nc" id="L157">		var cleartextFile = fileChooser.showOpenDialog(mainWindow);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">		if (cleartextFile != null) {</span>
<span class="nc" id="L159">			var ciphertextPaths = getCiphertextPath(cleartextFile.toPath()).stream().toList();</span>
<span class="nc" id="L160">			revealOrCopyPaths(ciphertextPaths);</span>
		}
<span class="nc" id="L162">	}</span>

	private boolean startsWithVaultAccessPoint(Path path) {
<span class="nc" id="L165">		return path.startsWith(Path.of(mountPoint.getValue()));</span>
	}

	private Optional&lt;Path&gt; getCiphertextPath(Path path) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">		if (!startsWithVaultAccessPoint(path)) {</span>
<span class="nc" id="L170">			LOG.debug(&quot;Path does not start with access point of selected vault: {}&quot;, path);</span>
<span class="nc" id="L171">			return Optional.empty();</span>
		}
		try {
<span class="nc" id="L174">			return Optional.of(vault.get().getCiphertextPath(path));</span>
<span class="nc" id="L175">		} catch (IOException e) {</span>
<span class="nc" id="L176">			LOG.warn(&quot;Unable to get ciphertext path from path: {}&quot;, path, e);</span>
<span class="nc" id="L177">			return Optional.empty();</span>
		}
	}

	private void revealOrCopyPaths(List&lt;Path&gt; paths) {
<span class="nc" id="L182">		revealPathService.ifPresentOrElse(svc -&gt; revealPaths(svc, paths), () -&gt; {</span>
<span class="nc" id="L183">			LOG.warn(&quot;No service provider to reveal files found.&quot;);</span>
<span class="nc" id="L184">			copyPathsToClipboard(paths);</span>
<span class="nc" id="L185">		});</span>
<span class="nc" id="L186">	}</span>

	private void revealPaths(RevealPathService service, List&lt;Path&gt; paths) {
<span class="nc" id="L189">		paths.forEach(path -&gt; {</span>
			try {
<span class="nc" id="L191">				LOG.debug(&quot;Revealing {}&quot;, path);</span>
<span class="nc" id="L192">				service.reveal(path);</span>
<span class="nc" id="L193">			} catch (RevealFailedException e) {</span>
<span class="nc" id="L194">				LOG.error(&quot;Revealing ciphertext file failed.&quot;, e);</span>
<span class="nc" id="L195">			}</span>
<span class="nc" id="L196">		});</span>
<span class="nc" id="L197">	}</span>

	private void copyPathsToClipboard(List&lt;Path&gt; paths) {
<span class="nc" id="L200">		StringBuilder clipboardString = new StringBuilder();</span>
<span class="nc" id="L201">		paths.forEach(p -&gt; clipboardString.append(p.toString()).append(&quot;\n&quot;));</span>
<span class="nc" id="L202">		Clipboard.getSystemClipboard().setContent(Map.of(DataFormat.PLAIN_TEXT, clipboardString.toString()));</span>
<span class="nc" id="L203">		ciphertextPathsCopied.setValue(true);</span>
<span class="nc" id="L204">		CompletableFuture.delayedExecutor(2, TimeUnit.SECONDS, Platform::runLater).execute(() -&gt; {</span>
<span class="nc" id="L205">			ciphertextPathsCopied.set(false);</span>
<span class="nc" id="L206">		});</span>
<span class="nc" id="L207">	}</span>

	/* Getter/Setter */

	public ReadOnlyObjectProperty&lt;Vault&gt; vaultProperty() {
<span class="nc" id="L212">		return vault;</span>
	}

	public Vault getVault() {
<span class="nc" id="L216">		return vault.get();</span>
	}

	public ObservableValue&lt;Boolean&gt; accessibleViaPathProperty() {
<span class="nc" id="L220">		return accessibleViaPath;</span>
	}

	public boolean isAccessibleViaPath() {
<span class="nc" id="L224">		return accessibleViaPath.getValue();</span>
	}

	public ObservableValue&lt;Boolean&gt; accessibleViaUriProperty() {
<span class="nc" id="L228">		return accessibleViaUri;</span>
	}

	public boolean isAccessibleViaUri() {
<span class="nc" id="L232">		return accessibleViaUri.getValue();</span>
	}

	public ObservableValue&lt;String&gt; mountPointProperty() {
<span class="nc" id="L236">		return mountPoint;</span>
	}

	public String getMountPoint() {
<span class="nc" id="L240">		return mountPoint.getValue();</span>
	}

	public BooleanProperty ciphertextPathsCopiedProperty() {
<span class="nc" id="L244">		return ciphertextPathsCopied;</span>
	}

	public boolean isCiphertextPathsCopied() {
<span class="nc" id="L248">		return ciphertextPathsCopied.get();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>