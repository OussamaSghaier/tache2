<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VaultListController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.mainwindow</a> &gt; <span class="el_source">VaultListController.java</span></div><h1>VaultListController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.mainwindow;

import org.apache.commons.lang3.SystemUtils;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.common.vaults.VaultListManager;
import org.cryptomator.cryptofs.CryptoFileSystemProvider;
import org.cryptomator.cryptofs.DirStructure;
import org.cryptomator.ui.addvaultwizard.AddVaultWizardComponent;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.common.VaultService;
import org.cryptomator.ui.fxapp.FxApplicationWindows;
import org.cryptomator.ui.removevault.RemoveVaultComponent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javafx.beans.binding.Bindings;
import javafx.beans.binding.BooleanBinding;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.ObjectProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.value.ObservableValue;
import javafx.collections.ListChangeListener;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.geometry.Side;
import javafx.scene.control.Button;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.ListView;
import javafx.scene.input.ContextMenuEvent;
import javafx.scene.input.DragEvent;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.input.MouseEvent;
import javafx.scene.input.TransferMode;
import javafx.scene.layout.StackPane;
import javafx.stage.Stage;
import java.io.File;
import java.io.IOException;
import java.nio.file.Path;
import java.util.EnumSet;
import java.util.Optional;
import java.util.ResourceBundle;
import java.util.Set;
import java.util.stream.Collectors;

import static org.cryptomator.common.Constants.CRYPTOMATOR_FILENAME_EXT;
import static org.cryptomator.common.Constants.MASTERKEY_FILENAME;
import static org.cryptomator.common.Constants.VAULTCONFIG_FILENAME;
import static org.cryptomator.common.vaults.VaultState.Value.ERROR;
import static org.cryptomator.common.vaults.VaultState.Value.LOCKED;
import static org.cryptomator.common.vaults.VaultState.Value.MISSING;
import static org.cryptomator.common.vaults.VaultState.Value.NEEDS_MIGRATION;

@MainWindowScoped
public class VaultListController implements FxController {

<span class="nc" id="L58">	private static final Logger LOG = LoggerFactory.getLogger(VaultListController.class);</span>

	private final Stage mainWindow;
	private final ObservableList&lt;Vault&gt; vaults;
	private final VaultService vaultService;
	private final ObjectProperty&lt;Vault&gt; selectedVault;
	private final VaultListCellFactory cellFactory;
	private final AddVaultWizardComponent.Builder addVaultWizard;
	private final BooleanBinding emptyVaultList;
	private final RemoveVaultComponent.Builder removeVaultDialogue;
	private final VaultListManager vaultListManager;
<span class="nc" id="L69">	private final BooleanProperty draggingVaultOver = new SimpleBooleanProperty();</span>
	private final ResourceBundle resourceBundle;
	private final FxApplicationWindows appWindows;

	public ListView&lt;Vault&gt; vaultList;
	public StackPane root;
	public Button addVaultBtn;
	@FXML
	private ContextMenu addVaultContextMenu;

	@Inject
	VaultListController(@MainWindow Stage mainWindow, //
						ObservableList&lt;Vault&gt; vaults, //
						ObjectProperty&lt;Vault&gt; selectedVault, //
						VaultListCellFactory cellFactory, //
						VaultService vaultService, //
						AddVaultWizardComponent.Builder addVaultWizard, //
						RemoveVaultComponent.Builder removeVaultDialogue, //
						VaultListManager vaultListManager, //
						ResourceBundle resourceBundle, //
<span class="nc" id="L89">						FxApplicationWindows appWindows) {</span>
<span class="nc" id="L90">		this.mainWindow = mainWindow;</span>
<span class="nc" id="L91">		this.vaults = vaults;</span>
<span class="nc" id="L92">		this.selectedVault = selectedVault;</span>
<span class="nc" id="L93">		this.cellFactory = cellFactory;</span>
<span class="nc" id="L94">		this.vaultService = vaultService;</span>
<span class="nc" id="L95">		this.addVaultWizard = addVaultWizard;</span>
<span class="nc" id="L96">		this.removeVaultDialogue = removeVaultDialogue;</span>
<span class="nc" id="L97">		this.vaultListManager = vaultListManager;</span>
<span class="nc" id="L98">		this.resourceBundle = resourceBundle;</span>
<span class="nc" id="L99">		this.appWindows = appWindows;</span>

<span class="nc" id="L101">		this.emptyVaultList = Bindings.isEmpty(vaults);</span>

<span class="nc" id="L103">		selectedVault.addListener(this::selectedVaultDidChange);</span>
<span class="nc" id="L104">	}</span>

	public void initialize() {
<span class="nc" id="L107">		vaultList.setItems(vaults);</span>
<span class="nc" id="L108">		vaultList.setCellFactory(cellFactory);</span>
<span class="nc" id="L109">		selectedVault.bind(vaultList.getSelectionModel().selectedItemProperty());</span>
<span class="nc" id="L110">		vaults.addListener((ListChangeListener.Change&lt;? extends Vault&gt; c) -&gt; {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			while (c.next()) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">				if (c.wasAdded()) {</span>
<span class="nc" id="L113">					Vault anyAddedVault = c.getAddedSubList().get(0);</span>
<span class="nc" id="L114">					vaultList.getSelectionModel().select(anyAddedVault);</span>
<span class="nc" id="L115">				}</span>
			}
<span class="nc" id="L117">		});</span>
<span class="nc" id="L118">		vaultList.addEventFilter(MouseEvent.MOUSE_RELEASED, this::deselect);</span>

		//unlock vault on double click
<span class="nc" id="L121">		vaultList.addEventFilter(MouseEvent.MOUSE_CLICKED, click -&gt; {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">			if (click.getClickCount() &gt;= 2) {</span>
<span class="nc" id="L123">				Optional.ofNullable(selectedVault.get())</span>
<span class="nc" id="L124">						.filter(Vault::isLocked)</span>
<span class="nc" id="L125">						.ifPresent(vault -&gt; appWindows.startUnlockWorkflow(vault, mainWindow));</span>
<span class="nc" id="L126">				Optional.ofNullable(selectedVault.get())</span>
<span class="nc" id="L127">						.filter(Vault::isUnlocked)</span>
<span class="nc" id="L128">						.ifPresent(vaultService::reveal);</span>
			}
<span class="nc" id="L130">		});</span>

		//don't show context menu when no vault selected
<span class="nc" id="L133">		vaultList.addEventFilter(ContextMenuEvent.CONTEXT_MENU_REQUESTED, request -&gt; {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			if (selectedVault.get() == null) {</span>
<span class="nc" id="L135">				request.consume();</span>
			}
<span class="nc" id="L137">		});</span>

		//show removeVaultDialog on certain key press
<span class="nc" id="L140">		vaultList.addEventFilter(KeyEvent.KEY_PRESSED, keyEvent -&gt; {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">			if (keyEvent.getCode() == KeyCode.DELETE) {</span>
<span class="nc" id="L142">				pressedShortcutToRemoveVault();</span>
<span class="nc" id="L143">				keyEvent.consume();</span>
			}
<span class="nc" id="L145">		});</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (SystemUtils.IS_OS_MAC) {</span>
<span class="nc" id="L147">			vaultList.addEventFilter(KeyEvent.KEY_PRESSED, keyEvent -&gt; {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">				if (keyEvent.getCode() == KeyCode.BACK_SPACE) {</span>
<span class="nc" id="L149">					pressedShortcutToRemoveVault();</span>
<span class="nc" id="L150">					keyEvent.consume();</span>
				}
<span class="nc" id="L152">			});</span>
		}

		//register vault selection shortcut to the main window
<span class="nc" id="L156">		mainWindow.addEventFilter(KeyEvent.KEY_RELEASED, keyEvent -&gt; {</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">			if (keyEvent.isShortcutDown() &amp;&amp; keyEvent.getCode().isDigitKey()) {</span>
<span class="nc" id="L158">				vaultList.getSelectionModel().select(Integer.parseInt(keyEvent.getText()) - 1);</span>
<span class="nc" id="L159">				keyEvent.consume();</span>
			}
<span class="nc" id="L161">		});</span>

<span class="nc" id="L163">		root.setOnDragEntered(this::handleDragEvent);</span>
<span class="nc" id="L164">		root.setOnDragOver(this::handleDragEvent);</span>
<span class="nc" id="L165">		root.setOnDragDropped(this::handleDragEvent);</span>
<span class="nc" id="L166">		root.setOnDragExited(this::handleDragEvent);</span>
<span class="nc" id="L167">	}</span>

	@FXML
	private void toggleMenu() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (addVaultContextMenu.isShowing()) {</span>
<span class="nc" id="L172">			addVaultContextMenu.hide();</span>
		} else {
<span class="nc" id="L174">			addVaultContextMenu.show(addVaultBtn, Side.BOTTOM, 0.0, 0.0);</span>
		}
<span class="nc" id="L176">	}</span>

	private void deselect(MouseEvent released) {
<span class="nc bnc" id="L179" title="All 2 branches missed.">		if (released.getY() &gt; (vaultList.getItems().size() * vaultList.fixedCellSizeProperty().get())) {</span>
<span class="nc" id="L180">			vaultList.getSelectionModel().clearSelection();</span>
<span class="nc" id="L181">			released.consume();</span>
		}
<span class="nc" id="L183">	}</span>

	private void selectedVaultDidChange(@SuppressWarnings(&quot;unused&quot;) ObservableValue&lt;? extends Vault&gt; observableValue, @SuppressWarnings(&quot;unused&quot;) Vault oldValue, Vault newValue) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if (newValue == null) {</span>
<span class="nc" id="L187">			return;</span>
		}
<span class="nc" id="L189">		VaultListManager.redetermineVaultState(newValue);</span>
<span class="nc" id="L190">	}</span>

	@FXML
	public void didClickAddNewVault() {
<span class="nc" id="L194">		addVaultWizard.build().showAddNewVaultWizard(resourceBundle);</span>
<span class="nc" id="L195">	}</span>

	@FXML
	public void didClickAddExistingVault() {
<span class="nc" id="L199">		addVaultWizard.build().showAddExistingVaultWizard(resourceBundle);</span>
<span class="nc" id="L200">	}</span>

	private void pressedShortcutToRemoveVault() {
<span class="nc" id="L203">		final var vault = selectedVault.get();</span>
<span class="nc bnc" id="L204" title="All 4 branches missed.">		if (vault != null &amp;&amp; EnumSet.of(LOCKED, MISSING, ERROR, NEEDS_MIGRATION).contains(vault.getState())) {</span>
<span class="nc" id="L205">			removeVaultDialogue.vault(vault).build().showRemoveVault();</span>
		}
<span class="nc" id="L207">	}</span>

	private void handleDragEvent(DragEvent event) {
<span class="nc bnc" id="L210" title="All 6 branches missed.">		if (DragEvent.DRAG_OVER.equals(event.getEventType()) &amp;&amp; event.getGestureSource() == null &amp;&amp; event.getDragboard().hasFiles()) {</span>
<span class="nc" id="L211">			draggingVaultOver.set(event.getDragboard().getFiles().stream().map(File::toPath).anyMatch(this::containsVault));</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (draggingVaultOver.get()) {</span>
<span class="nc" id="L213">				event.acceptTransferModes(TransferMode.ANY);</span>
			}
<span class="nc bnc" id="L215" title="All 6 branches missed.">		} else if (DragEvent.DRAG_DROPPED.equals(event.getEventType()) &amp;&amp; event.getGestureSource() == null &amp;&amp; event.getDragboard().hasFiles()) {</span>
<span class="nc" id="L216">			Set&lt;Path&gt; vaultPaths = event.getDragboard().getFiles().stream().map(File::toPath).filter(this::containsVault).collect(Collectors.toSet());</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if (!vaultPaths.isEmpty()) {</span>
<span class="nc" id="L218">				vaultPaths.forEach(this::addVault);</span>
			}
<span class="nc bnc" id="L220" title="All 2 branches missed.">			event.setDropCompleted(!vaultPaths.isEmpty());</span>
<span class="nc" id="L221">			event.consume();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		} else if (DragEvent.DRAG_EXITED.equals(event.getEventType())) {</span>
<span class="nc" id="L223">			draggingVaultOver.set(false);</span>
		}
<span class="nc" id="L225">	}</span>

	private boolean containsVault(Path path) {
		try {
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if (path.getFileName().toString().endsWith(CRYPTOMATOR_FILENAME_EXT)) {</span>
<span class="nc" id="L230">				path = path.getParent();</span>
			}
<span class="nc bnc" id="L232" title="All 2 branches missed.">			return CryptoFileSystemProvider.checkDirStructureForVault(path, VAULTCONFIG_FILENAME, MASTERKEY_FILENAME) != DirStructure.UNRELATED;</span>
<span class="nc" id="L233">		} catch (IOException e) {</span>
<span class="nc" id="L234">			return false;</span>
		}
	}

	private void addVault(Path pathToVault) {
		try {
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (pathToVault.getFileName().toString().endsWith(CRYPTOMATOR_FILENAME_EXT)) {</span>
<span class="nc" id="L241">				vaultListManager.add(pathToVault.getParent());</span>
			} else {
<span class="nc" id="L243">				vaultListManager.add(pathToVault);</span>
			}
<span class="nc" id="L245">		} catch (IOException e) {</span>
<span class="nc" id="L246">			LOG.debug(&quot;Not a vault: {}&quot;, pathToVault);</span>
<span class="nc" id="L247">		}</span>
<span class="nc" id="L248">	}</span>

	// Getter and Setter

	public BooleanBinding emptyVaultListProperty() {
<span class="nc" id="L253">		return emptyVaultList;</span>
	}

	public boolean isEmptyVaultList() {
<span class="nc" id="L257">		return emptyVaultList.get();</span>
	}

	public BooleanProperty draggingVaultOverProperty() {
<span class="nc" id="L261">		return draggingVaultOver;</span>
	}

	public boolean isDraggingVaultOver() {
<span class="nc" id="L265">		return draggingVaultOver.get();</span>
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>