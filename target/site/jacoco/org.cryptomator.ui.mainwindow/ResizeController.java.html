<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResizeController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.mainwindow</a> &gt; <span class="el_source">ResizeController.java</span></div><h1>ResizeController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.mainwindow;

import org.cryptomator.common.settings.Settings;
import org.cryptomator.ui.common.FxController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javafx.beans.binding.BooleanBinding;
import javafx.fxml.FXML;
import javafx.geometry.Rectangle2D;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.Region;
import javafx.stage.Screen;
import javafx.stage.Stage;
import javafx.stage.WindowEvent;

@MainWindow
public class ResizeController implements FxController {

<span class="nc" id="L21">	private static final Logger LOG = LoggerFactory.getLogger(ResizeController.class);</span>

	private final Stage window;

	public Region tlResizer;
	public Region trResizer;
	public Region blResizer;
	public Region brResizer;
	public Region tResizer;
	public Region rResizer;
	public Region bResizer;
	public Region lResizer;
	public Region lDefaultRegion;
	public Region tDefaultRegion;
	public Region rDefaultRegion;
	public Region bDefaultRegion;

	private double origX, origY, origW, origH;

	private final Settings settings;

	private final BooleanBinding showResizingArrows;

	@Inject
<span class="nc" id="L45">	ResizeController(@MainWindow Stage window, Settings settings) {</span>
<span class="nc" id="L46">		this.window = window;</span>
<span class="nc" id="L47">		this.settings = settings;</span>
<span class="nc" id="L48">		this.showResizingArrows = window.fullScreenProperty().not();</span>
<span class="nc" id="L49">	}</span>

	@FXML
	public void initialize() {
<span class="nc" id="L53">		LOG.trace(&quot;init ResizeController&quot;);</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (!neverTouched()) {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">			window.setHeight(settings.windowHeight.get() &gt; window.getMinHeight() ? settings.windowHeight.get() : window.getMinHeight());</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">			window.setWidth(settings.windowWidth.get() &gt; window.getMinWidth() ? settings.windowWidth.get() : window.getMinWidth());</span>
<span class="nc" id="L58">			window.setX(settings.windowXPosition.get());</span>
<span class="nc" id="L59">			window.setY(settings.windowYPosition.get());</span>
		}

<span class="nc" id="L62">		window.setOnShowing(this::checkDisplayBounds);</span>
<span class="nc" id="L63">	}</span>

	private boolean neverTouched() {
<span class="nc bnc" id="L66" title="All 8 branches missed.">		return (settings.windowHeight.get() == 0) &amp;&amp; (settings.windowWidth.get() == 0) &amp;&amp; (settings.windowXPosition.get() == 0) &amp;&amp; (settings.windowYPosition.get() == 0);</span>
	}

	private void checkDisplayBounds(WindowEvent evt) {
		// Minimizing a window in Windows and closing it could result in an out of bounds position at (x, y) = (-32000, -32000)
		// See https://devblogs.microsoft.com/oldnewthing/20041028-00/?p=37453
		// If the position is (-32000, -32000), restore to the last saved position
<span class="nc bnc" id="L73" title="All 4 branches missed.">		if (window.getX() == -32000 &amp;&amp; window.getY() == -32000) {</span>
<span class="nc" id="L74">			window.setX(settings.windowXPosition.get());</span>
<span class="nc" id="L75">			window.setY(settings.windowYPosition.get());</span>
<span class="nc" id="L76">			window.setWidth(settings.windowWidth.get());</span>
<span class="nc" id="L77">			window.setHeight(settings.windowHeight.get());</span>
		}

<span class="nc bnc" id="L80" title="All 2 branches missed.">		if (isOutOfDisplayBounds()) {</span>
			// If the position is illegal, then the window appears on the main screen in the middle of the window.
<span class="nc" id="L82">			LOG.debug(&quot;Resetting window position due to insufficient screen overlap&quot;);</span>
<span class="nc" id="L83">			Rectangle2D primaryScreenBounds = Screen.getPrimary().getBounds();</span>
<span class="nc" id="L84">			window.setX((primaryScreenBounds.getWidth() - window.getMinWidth()) / 2);</span>
<span class="nc" id="L85">			window.setY((primaryScreenBounds.getHeight() - window.getMinHeight()) / 2);</span>
<span class="nc" id="L86">			window.setWidth(window.getMinWidth());</span>
<span class="nc" id="L87">			window.setHeight(window.getMinHeight());</span>
<span class="nc" id="L88">			savePositionalSettings();</span>
		}
<span class="nc" id="L90">	}</span>

	private boolean isOutOfDisplayBounds() {
		// define a rect which is inset on all sides from the window's rect:
<span class="nc" id="L94">		final double x = window.getX() + 20; // 20px left</span>
<span class="nc" id="L95">		final double y = window.getY() + 5; // 5px top</span>
<span class="nc" id="L96">		final double w = window.getWidth() - 40; // 20px left + 20px right</span>
<span class="nc" id="L97">		final double h = window.getHeight() - 25; // 5px top + 20px bottom</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		return isRectangleOutOfScreen(x, y, 0, h) // Left pixel column</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">				|| isRectangleOutOfScreen(x + w, y, 0, h) // Right pixel column</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">				|| isRectangleOutOfScreen(x, y, w, 0) // Top pixel row</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">				|| isRectangleOutOfScreen(x, y + h, w, 0); // Bottom pixel row</span>
	}

	private boolean isRectangleOutOfScreen(double x, double y, double width, double height) {
<span class="nc" id="L105">		return Screen.getScreensForRectangle(x, y, width, height).isEmpty();</span>
	}

	private void startResize(MouseEvent evt) {
<span class="nc" id="L109">		origX = window.getX();</span>
<span class="nc" id="L110">		origY = window.getY();</span>
<span class="nc" id="L111">		origW = window.getWidth();</span>
<span class="nc" id="L112">		origH = window.getHeight();</span>
<span class="nc" id="L113">	}</span>

	@FXML
	private void resizeTopLeft(MouseEvent evt) {
<span class="nc" id="L117">		resizeTop(evt);</span>
<span class="nc" id="L118">		resizeLeft(evt);</span>
<span class="nc" id="L119">	}</span>

	@FXML
	private void resizeTopRight(MouseEvent evt) {
<span class="nc" id="L123">		resizeTop(evt);</span>
<span class="nc" id="L124">		resizeRight(evt);</span>
<span class="nc" id="L125">	}</span>

	@FXML
	private void resizeBottomLeft(MouseEvent evt) {
<span class="nc" id="L129">		resizeBottom(evt);</span>
<span class="nc" id="L130">		resizeLeft(evt);</span>
<span class="nc" id="L131">	}</span>

	@FXML
	private void resizeBottomRight(MouseEvent evt) {
<span class="nc" id="L135">		resizeBottom(evt);</span>
<span class="nc" id="L136">		resizeRight(evt);</span>
<span class="nc" id="L137">	}</span>

	@FXML
	private void resizeTop(MouseEvent evt) {
<span class="nc" id="L141">		startResize(evt);</span>
<span class="nc" id="L142">		double newY = evt.getScreenY();</span>
<span class="nc" id="L143">		double dy = newY - origY;</span>
<span class="nc" id="L144">		double newH = origH - dy;</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">		if (newH &lt; window.getMaxHeight() &amp;&amp; newH &gt; window.getMinHeight()) {</span>
<span class="nc" id="L146">			window.setY(newY);</span>
<span class="nc" id="L147">			window.setHeight(newH);</span>
		}
<span class="nc" id="L149">	}</span>

	@FXML
	private void resizeLeft(MouseEvent evt) {
<span class="nc" id="L153">		startResize(evt);</span>
<span class="nc" id="L154">		double newX = evt.getScreenX();</span>
<span class="nc" id="L155">		double dx = newX - origX;</span>
<span class="nc" id="L156">		double newW = origW - dx;</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">		if (newW &lt; window.getMaxWidth() &amp;&amp; newW &gt; window.getMinWidth()) {</span>
<span class="nc" id="L158">			window.setX(newX);</span>
<span class="nc" id="L159">			window.setWidth(newW);</span>
		}
<span class="nc" id="L161">	}</span>

	@FXML
	private void resizeBottom(MouseEvent evt) {
<span class="nc" id="L165">		double newH = evt.getSceneY();</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">		if (newH &lt; window.getMaxHeight() &amp;&amp; newH &gt; window.getMinHeight()) {</span>
<span class="nc" id="L167">			window.setHeight(newH);</span>
		}
<span class="nc" id="L169">	}</span>

	@FXML
	private void resizeRight(MouseEvent evt) {
<span class="nc" id="L173">		double newW = evt.getSceneX();</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">		if (newW &lt; window.getMaxWidth() &amp;&amp; newW &gt; window.getMinWidth()) {</span>
<span class="nc" id="L175">			window.setWidth(newW);</span>
		}
<span class="nc" id="L177">	}</span>

	@FXML
	public void savePositionalSettings() {
<span class="nc" id="L181">		settings.windowWidth.setValue(window.getWidth());</span>
<span class="nc" id="L182">		settings.windowHeight.setValue(window.getHeight());</span>
<span class="nc" id="L183">		settings.windowXPosition.setValue(window.getX());</span>
<span class="nc" id="L184">		settings.windowYPosition.setValue(window.getY());</span>
<span class="nc" id="L185">	}</span>

	public BooleanBinding showResizingArrowsProperty() {
<span class="nc" id="L188">		return showResizingArrows;</span>
	}

	public boolean isShowResizingArrows() {
<span class="nc" id="L192">		return showResizingArrows.get();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>