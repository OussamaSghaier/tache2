<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DraggableListCell.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.controls</a> &gt; <span class="el_source">DraggableListCell.java</span></div><h1>DraggableListCell.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2016, 2017 Sebastian Stenzel and others.
 * All rights reserved.
 * This program and the accompanying materials are made available under the terms of the accompanying LICENSE file.
 *
 * Contributors:
 *     Sebastian Stenzel - initial API and implementation
 *******************************************************************************/
package org.cryptomator.ui.controls;

import com.tobiasdiez.easybind.EasyBind;

import javafx.beans.property.BooleanProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.scene.SnapshotParameters;
import javafx.scene.control.ListCell;
import javafx.scene.image.Image;
import javafx.scene.input.ClipboardContent;
import javafx.scene.input.DragEvent;
import javafx.scene.input.Dragboard;
import javafx.scene.input.MouseEvent;
import javafx.scene.input.TransferMode;
import java.util.List;

public class DraggableListCell&lt;T&gt; extends ListCell&lt;T&gt; {

	private static final String DROP_ABOVE_CLASS = &quot;drop-above&quot;;
	private static final String DROP_BELOW_CLASS = &quot;drop-below&quot;;

<span class="nc" id="L30">	private final BooleanProperty dropAbove = new SimpleBooleanProperty();</span>
<span class="nc" id="L31">	private final BooleanProperty dropBelow = new SimpleBooleanProperty();</span>

<span class="nc" id="L33">	public DraggableListCell() {</span>
<span class="nc" id="L34">		setOnDragDetected(this::onDragDetected);</span>
<span class="nc" id="L35">		setOnDragOver(this::onDragOver);</span>
<span class="nc" id="L36">		setOnDragEntered(this::onDragEntered);</span>
<span class="nc" id="L37">		setOnDragExited(this::onDragExited);</span>
<span class="nc" id="L38">		setOnDragDropped(this::onDragDropped);</span>
<span class="nc" id="L39">		setOnDragDone(DragEvent::consume);</span>

<span class="nc" id="L41">		EasyBind.includeWhen(getStyleClass(), DROP_ABOVE_CLASS, dropAbove);</span>
<span class="nc" id="L42">		EasyBind.includeWhen(getStyleClass(), DROP_BELOW_CLASS, dropBelow);</span>
<span class="nc" id="L43">	}</span>

	private void setDropPositionStyleClass(double verticalCursorPosition) {
<span class="nc bnc" id="L46" title="All 2 branches missed.">		boolean isUpperHalf = verticalCursorPosition &lt; this.getHeight() / 2.0;</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">		if (isUpperHalf) {</span>
<span class="nc" id="L48">			this.dropAbove.set(true);</span>
<span class="nc" id="L49">			this.dropBelow.set(false);</span>
		} else {
<span class="nc" id="L51">			this.dropAbove.set(false);</span>
<span class="nc" id="L52">			this.dropBelow.set(true);</span>
		}
<span class="nc" id="L54">	}</span>

	private void resetDropPositionStyleClasses() {
<span class="nc" id="L57">		this.dropAbove.set(false);</span>
<span class="nc" id="L58">		this.dropBelow.set(false);</span>
<span class="nc" id="L59">	}</span>

	private void onDragDetected(MouseEvent event) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (getItem() == null) {</span>
<span class="nc" id="L63">			return;</span>
		}

<span class="nc" id="L66">		final ClipboardContent content = new ClipboardContent();</span>
<span class="nc" id="L67">		content.putString(Integer.toString(getIndex()));</span>
<span class="nc" id="L68">		final Image snapshot = this.snapshot(new SnapshotParameters(), null);</span>
<span class="nc" id="L69">		final Dragboard dragboard = startDragAndDrop(TransferMode.MOVE);</span>
<span class="nc" id="L70">		dragboard.setDragView(snapshot);</span>
<span class="nc" id="L71">		dragboard.setContent(content);</span>

<span class="nc" id="L73">		event.consume();</span>
<span class="nc" id="L74">	}</span>

	private void onDragOver(DragEvent event) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (getItem() == null) {</span>
<span class="nc" id="L78">			return;</span>
		}

<span class="nc bnc" id="L81" title="All 6 branches missed.">		if (event.getGestureSource() instanceof DraggableListCell&lt;?&gt; &amp;&amp; event.getGestureSource() != this &amp;&amp; event.getDragboard().hasString()) {</span>
<span class="nc" id="L82">			event.acceptTransferModes(TransferMode.MOVE);</span>
<span class="nc" id="L83">			setDropPositionStyleClass(event.getY());</span>
		}

<span class="nc" id="L86">		event.consume();</span>
<span class="nc" id="L87">	}</span>

	private void onDragEntered(DragEvent event) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if (getItem() == null) {</span>
<span class="nc" id="L91">			return;</span>
		}

<span class="nc bnc" id="L94" title="All 6 branches missed.">		if (event.getGestureSource() instanceof DraggableListCell&lt;?&gt; &amp;&amp; event.getGestureSource() != this &amp;&amp; event.getDragboard().hasString()) {</span>
<span class="nc" id="L95">			setDropPositionStyleClass(event.getY());</span>
		}
<span class="nc" id="L97">	}</span>

	private void onDragExited(DragEvent event) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (getItem() == null) {</span>
<span class="nc" id="L101">			return;</span>
		}

<span class="nc bnc" id="L104" title="All 6 branches missed.">		if (event.getGestureSource() instanceof DraggableListCell&lt;?&gt; &amp;&amp; event.getGestureSource() != this &amp;&amp; event.getDragboard().hasString()) {</span>
<span class="nc" id="L105">			resetDropPositionStyleClasses();</span>
		}
<span class="nc" id="L107">	}</span>

	private void onDragDropped(DragEvent event) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (getItem() == null) {</span>
<span class="nc" id="L111">			return;</span>
		}

<span class="nc bnc" id="L114" title="All 4 branches missed.">		if (event.getGestureSource() instanceof DraggableListCell&lt;?&gt; &amp;&amp; event.getDragboard().hasString()) {</span>
<span class="nc" id="L115">			final List&lt;T&gt; list = getListView().getItems();</span>
			try {
				// where to insert what?
<span class="nc" id="L118">				final int draggedIdx = Integer.parseInt(event.getDragboard().getString());</span>
<span class="nc" id="L119">				final T currentItem = this.getItem();</span>
<span class="nc" id="L120">				final T draggedItem = list.remove(draggedIdx);</span>
<span class="nc" id="L121">				final int currentItemIdx = list.indexOf(currentItem);</span>

				// insert before or after currentItem?
<span class="nc bnc" id="L124" title="All 2 branches missed.">				boolean insertBefore = event.getY() &lt; this.getHeight() / 2.0;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				final int insertPosition = insertBefore ? currentItemIdx : currentItemIdx + 1;</span>

				// insert!
<span class="nc" id="L128">				getListView().getItems().add(insertPosition, draggedItem);</span>
<span class="nc" id="L129">				getListView().getSelectionModel().select(insertPosition);</span>
<span class="nc" id="L130">				event.setDropCompleted(true);</span>
<span class="nc" id="L131">			} catch (NumberFormatException e) {</span>
<span class="nc" id="L132">				event.setDropCompleted(false);</span>
<span class="nc" id="L133">			}</span>
		}

<span class="nc" id="L136">		event.consume();</span>
<span class="nc" id="L137">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>