<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FxApplicationWindows.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.fxapp</a> &gt; <span class="el_source">FxApplicationWindows.java</span></div><h1>FxApplicationWindows.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.fxapp;

import com.google.common.base.Preconditions;
import dagger.Lazy;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.common.vaults.VaultState;
import org.cryptomator.integrations.tray.TrayIntegrationProvider;
import org.cryptomator.ui.dokanysupportend.DokanySupportEndComponent;
import org.cryptomator.ui.error.ErrorComponent;
import org.cryptomator.ui.lock.LockComponent;
import org.cryptomator.ui.mainwindow.MainWindowComponent;
import org.cryptomator.ui.preferences.PreferencesComponent;
import org.cryptomator.ui.preferences.SelectedPreferencesTab;
import org.cryptomator.ui.quit.QuitComponent;
import org.cryptomator.ui.sharevault.ShareVaultComponent;
import org.cryptomator.ui.unlock.UnlockComponent;
import org.cryptomator.ui.unlock.UnlockWorkflow;
import org.cryptomator.ui.updatereminder.UpdateReminderComponent;
import org.cryptomator.ui.vaultoptions.SelectedVaultOptionsTab;
import org.cryptomator.ui.vaultoptions.VaultOptionsComponent;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javafx.application.Platform;
import javafx.collections.ListChangeListener;
import javafx.collections.transformation.FilteredList;
import javafx.scene.Scene;
import javafx.stage.Stage;
import javafx.stage.Window;
import java.awt.Desktop;
import java.awt.desktop.AppReopenedListener;
import java.awt.desktop.QuitResponse;
import java.util.Optional;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.ExecutorService;

@FxApplicationScoped
public class FxApplicationWindows {

<span class="fc" id="L43">	private static final Logger LOG = LoggerFactory.getLogger(FxApplicationWindows.class);</span>

	private final Stage primaryStage;
	private final Optional&lt;TrayIntegrationProvider&gt; trayIntegration;
	private final Lazy&lt;MainWindowComponent&gt; mainWindow;
	private final Lazy&lt;PreferencesComponent&gt; preferencesWindow;
	private final QuitComponent.Builder quitWindowBuilder;
	private final UnlockComponent.Factory unlockWorkflowFactory;
	private final UpdateReminderComponent.Factory updateReminderWindowBuilder;
	private final DokanySupportEndComponent.Factory dokanySupportEndWindowBuilder;
	private final LockComponent.Factory lockWorkflowFactory;
	private final ErrorComponent.Factory errorWindowFactory;
	private final ExecutorService executor;
	private final VaultOptionsComponent.Factory vaultOptionsWindow;
	private final ShareVaultComponent.Factory shareVaultWindow;
	private final FilteredList&lt;Window&gt; visibleWindows;

	@Inject
	public FxApplicationWindows(@PrimaryStage Stage primaryStage, //
								Optional&lt;TrayIntegrationProvider&gt; trayIntegration, //
								Lazy&lt;MainWindowComponent&gt; mainWindow, //
								Lazy&lt;PreferencesComponent&gt; preferencesWindow, //
								QuitComponent.Builder quitWindowBuilder, //
								UnlockComponent.Factory unlockWorkflowFactory, //
								UpdateReminderComponent.Factory updateReminderWindowBuilder, //
								DokanySupportEndComponent.Factory dokanySupportEndWindowBuilder, //
								LockComponent.Factory lockWorkflowFactory, //
								ErrorComponent.Factory errorWindowFactory, //
								VaultOptionsComponent.Factory vaultOptionsWindow, //
								ShareVaultComponent.Factory shareVaultWindow, //
<span class="nc" id="L73">								ExecutorService executor) {</span>
<span class="nc" id="L74">		this.primaryStage = primaryStage;</span>
<span class="nc" id="L75">		this.trayIntegration = trayIntegration;</span>
<span class="nc" id="L76">		this.mainWindow = mainWindow;</span>
<span class="nc" id="L77">		this.preferencesWindow = preferencesWindow;</span>
<span class="nc" id="L78">		this.quitWindowBuilder = quitWindowBuilder;</span>
<span class="nc" id="L79">		this.unlockWorkflowFactory = unlockWorkflowFactory;</span>
<span class="nc" id="L80">		this.updateReminderWindowBuilder = updateReminderWindowBuilder;</span>
<span class="nc" id="L81">		this.dokanySupportEndWindowBuilder = dokanySupportEndWindowBuilder;</span>
<span class="nc" id="L82">		this.lockWorkflowFactory = lockWorkflowFactory;</span>
<span class="nc" id="L83">		this.errorWindowFactory = errorWindowFactory;</span>
<span class="nc" id="L84">		this.executor = executor;</span>
<span class="nc" id="L85">		this.vaultOptionsWindow = vaultOptionsWindow;</span>
<span class="nc" id="L86">		this.shareVaultWindow = shareVaultWindow;</span>
<span class="nc" id="L87">		this.visibleWindows = Window.getWindows().filtered(Window::isShowing);</span>
<span class="nc" id="L88">	}</span>

	public void initialize() {
<span class="nc" id="L91">		Preconditions.checkState(Desktop.isDesktopSupported(), &quot;java.awt.Desktop not supported&quot;);</span>
<span class="nc" id="L92">		Desktop desktop = Desktop.getDesktop();</span>

		// register preferences shortcut
<span class="nc bnc" id="L95" title="All 2 branches missed.">		if (desktop.isSupported(Desktop.Action.APP_PREFERENCES)) {</span>
<span class="nc" id="L96">			desktop.setPreferencesHandler(evt -&gt; showPreferencesWindow(SelectedPreferencesTab.ANY));</span>
		}

		// register preferences shortcut
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (desktop.isSupported(Desktop.Action.APP_ABOUT)) {</span>
<span class="nc" id="L101">			desktop.setAboutHandler(evt -&gt; showPreferencesWindow(SelectedPreferencesTab.ABOUT));</span>
		}

		// register app reopen listener
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (desktop.isSupported(Desktop.Action.APP_EVENT_REOPENED)) {</span>
<span class="nc" id="L106">			desktop.addAppEventListener((AppReopenedListener) e -&gt; showMainWindow());</span>
		}

		// observe visible windows
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (trayIntegration.isPresent()) {</span>
<span class="nc" id="L111">			visibleWindows.addListener(this::visibleWindowsChanged);</span>
		}
<span class="nc" id="L113">	}</span>

	private void visibleWindowsChanged(ListChangeListener.Change&lt;? extends Window&gt; change) {
<span class="nc" id="L116">		int visibleWindows = change.getList().size();</span>
<span class="nc" id="L117">		LOG.debug(&quot;visible windows: {}&quot;, visibleWindows);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (visibleWindows &gt; 0) {</span>
<span class="nc" id="L119">			trayIntegration.ifPresent(TrayIntegrationProvider::restoredFromTray);</span>
		} else {
<span class="nc" id="L121">			trayIntegration.ifPresent(TrayIntegrationProvider::minimizedToTray);</span>
		}
<span class="nc" id="L123">	}</span>

	public CompletionStage&lt;Stage&gt; showMainWindow() {
<span class="nc" id="L126">		return CompletableFuture.supplyAsync(mainWindow.get()::showMainWindow, Platform::runLater).whenComplete(this::reportErrors);</span>
	}

	public CompletionStage&lt;Stage&gt; showPreferencesWindow(SelectedPreferencesTab selectedTab) {
<span class="nc" id="L130">		return CompletableFuture.supplyAsync(() -&gt; preferencesWindow.get().showPreferencesWindow(selectedTab), Platform::runLater).whenComplete(this::reportErrors);</span>
	}

	public void showShareVaultWindow(Vault vault) {
<span class="nc" id="L134">		CompletableFuture.runAsync(() -&gt; shareVaultWindow.create(vault).showShareVaultWindow(), Platform::runLater);</span>
<span class="nc" id="L135">	}</span>

	public CompletionStage&lt;Stage&gt; showVaultOptionsWindow(Vault vault, SelectedVaultOptionsTab tab) {
<span class="nc" id="L138">		return showMainWindow().thenApplyAsync((window) -&gt; vaultOptionsWindow.create(vault).showVaultOptionsWindow(tab), Platform::runLater).whenComplete(this::reportErrors);</span>
	}

	public void showQuitWindow(QuitResponse response, boolean forced) {
<span class="nc" id="L142">			CompletableFuture.runAsync(() -&gt; quitWindowBuilder.build().showQuitWindow(response,forced), Platform::runLater);</span>
<span class="nc" id="L143">	}</span>

	public void checkAndShowUpdateReminderWindow() {
<span class="nc" id="L146">		CompletableFuture.runAsync(() -&gt; updateReminderWindowBuilder.create().checkAndShowUpdateReminderWindow(), Platform::runLater);</span>
<span class="nc" id="L147">	}</span>

	public void showDokanySupportEndWindow() {
<span class="nc" id="L150">		CompletableFuture.runAsync(() -&gt; dokanySupportEndWindowBuilder.create().showDokanySupportEndWindow(), Platform::runLater);</span>
<span class="nc" id="L151">	}</span>


	public CompletionStage&lt;Void&gt; startUnlockWorkflow(Vault vault, @Nullable Stage owner) {
<span class="nc" id="L155">		return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="nc" id="L156">					Preconditions.checkState(vault.stateProperty().transition(VaultState.Value.LOCKED, VaultState.Value.PROCESSING), &quot;Vault not locked.&quot;);</span>
<span class="nc" id="L157">					LOG.debug(&quot;Start unlock workflow for {}&quot;, vault.getDisplayName());</span>
<span class="nc" id="L158">					return unlockWorkflowFactory.create(vault, owner).unlockWorkflow();</span>
				}, Platform::runLater) //
<span class="nc" id="L160">				.thenAcceptAsync(UnlockWorkflow::run, executor)</span>
<span class="nc" id="L161">				.exceptionally(e -&gt; {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">					showErrorWindow(e, owner == null ? primaryStage : owner, null);</span>
<span class="nc" id="L163">					return null;</span>
				});
	}

	public CompletionStage&lt;Void&gt; startLockWorkflow(Vault vault, @Nullable Stage owner) {
<span class="nc" id="L168">		return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="nc" id="L169">					Preconditions.checkState(vault.stateProperty().transition(VaultState.Value.UNLOCKED, VaultState.Value.PROCESSING), &quot;Vault not unlocked.&quot;);</span>
<span class="nc" id="L170">					LOG.debug(&quot;Start lock workflow for {}&quot;, vault.getDisplayName());</span>
<span class="nc" id="L171">					return lockWorkflowFactory.create(vault, owner).lockWorkflow();</span>
				}, Platform::runLater) //
<span class="nc" id="L173">				.thenCompose(lockWorkflow -&gt; CompletableFuture.runAsync(lockWorkflow, executor)) //</span>
<span class="nc" id="L174">				.exceptionally(e -&gt; {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">					showErrorWindow(e, owner == null ? primaryStage : owner, null);</span>
<span class="nc" id="L176">					return null;</span>
				});
	}

	/**
	 * Displays the generic error scene in the given window.
	 *
	 * @param cause The exception to show
	 * @param window What window to display the scene in
	 * @param previousScene To what scene to return to when pressing &quot;back&quot;. Back button will be hidden, if &lt;code&gt;null&lt;/code&gt;
	 * @return A
	 */
	public CompletionStage&lt;Stage&gt; showErrorWindow(Throwable cause, Stage window, @Nullable Scene previousScene) {
<span class="nc" id="L189">		return CompletableFuture.supplyAsync(() -&gt; errorWindowFactory.create(cause, window, previousScene).show(), Platform::runLater).whenComplete(this::reportErrors);</span>
	}

	private void reportErrors(@Nullable Stage stage, @Nullable Throwable error) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">		if (error != null) {</span>
<span class="nc" id="L194">			LOG.error(&quot;Failed to display stage&quot;, error);</span>
		}
<span class="nc" id="L196">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>