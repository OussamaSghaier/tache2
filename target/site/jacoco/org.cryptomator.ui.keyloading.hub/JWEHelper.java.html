<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JWEHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.keyloading.hub</a> &gt; <span class="el_source">JWEHelper.java</span></div><h1>JWEHelper.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.keyloading.hub;

import com.google.common.base.Preconditions;
import com.nimbusds.jose.EncryptionMethod;
import com.nimbusds.jose.JOSEException;
import com.nimbusds.jose.JWEAlgorithm;
import com.nimbusds.jose.JWEHeader;
import com.nimbusds.jose.JWEObject;
import com.nimbusds.jose.Payload;
import com.nimbusds.jose.crypto.ECDHDecrypter;
import com.nimbusds.jose.crypto.ECDHEncrypter;
import com.nimbusds.jose.crypto.PasswordBasedDecrypter;
import com.nimbusds.jose.jwk.Curve;
import com.nimbusds.jose.jwk.gen.ECKeyGenerator;
import org.cryptomator.cryptolib.api.CryptoException;
import org.cryptomator.cryptolib.api.Masterkey;
import org.cryptomator.cryptolib.api.MasterkeyLoadingFailedException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.security.Key;
import java.security.KeyFactory;
import java.security.NoSuchAlgorithmException;
import java.security.interfaces.ECPrivateKey;
import java.security.interfaces.ECPublicKey;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;
import java.util.Arrays;
import java.util.Base64;
import java.util.Map;
import java.util.function.Function;

class JWEHelper {

<span class="fc" id="L36">	private static final Logger LOG = LoggerFactory.getLogger(JWEHelper.class);</span>
	private static final String JWE_PAYLOAD_KEY_FIELD = &quot;key&quot;;
	private static final String EC_ALG = &quot;EC&quot;;

	private JWEHelper() {}

	public static JWEObject encryptUserKey(ECPrivateKey userKey, ECPublicKey deviceKey) {
<span class="fc" id="L43">		return encryptKey(userKey, deviceKey);</span>
	}

	public static ECPrivateKey decryptUserKey(JWEObject jwe, String setupCode) throws InvalidJweKeyException {
		try {
<span class="fc" id="L48">			jwe.decrypt(new PasswordBasedDecrypter(setupCode));</span>
<span class="fc" id="L49">			return readKey(jwe, JWE_PAYLOAD_KEY_FIELD, JWEHelper::decodeECPrivateKey);</span>
<span class="fc" id="L50">		} catch (JOSEException e) {</span>
<span class="fc" id="L51">			throw new InvalidJweKeyException(e);</span>
		}
	}

	public static ECPrivateKey decryptUserKey(JWEObject jwe, ECPrivateKey deviceKey) throws InvalidJweKeyException {
		try {
<span class="fc" id="L57">			jwe.decrypt(new ECDHDecrypter(deviceKey));</span>
<span class="fc" id="L58">			return readKey(jwe, JWE_PAYLOAD_KEY_FIELD, JWEHelper::decodeECPrivateKey);</span>
<span class="fc" id="L59">		} catch (JOSEException e) {</span>
<span class="fc" id="L60">			throw new InvalidJweKeyException(e);</span>
		}
	}

	/**
	 * Attempts to decode a DER-encoded EC private key.
	 *
	 * @param encoded DER-encoded EC private key
	 * @return the decoded key
	 * @throws KeyDecodeFailedException On malformed input
	 */
	public static ECPrivateKey decodeECPrivateKey(byte[] encoded) throws KeyDecodeFailedException {
		try {
<span class="fc" id="L73">			KeyFactory factory = KeyFactory.getInstance(EC_ALG);</span>
<span class="fc" id="L74">			var privateKey = factory.generatePrivate(new PKCS8EncodedKeySpec(encoded));</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">			if (privateKey instanceof ECPrivateKey ecPrivateKey) {</span>
<span class="fc" id="L76">				return ecPrivateKey;</span>
			} else {
<span class="nc" id="L78">				throw new IllegalStateException(EC_ALG + &quot; key factory not generating ECPrivateKeys&quot;);</span>
			}
<span class="nc" id="L80">		} catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L81">			throw new IllegalStateException(EC_ALG + &quot; not supported&quot;);</span>
<span class="nc" id="L82">		} catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L83">			throw new KeyDecodeFailedException(e);</span>
		}
	}

	/**
	 * Attempts to decode a DER-encoded EC public key.
	 *
	 * @param encoded DER-encoded EC public key
	 * @return the decoded key
	 * @throws KeyDecodeFailedException On malformed input
	 */
	public static ECPublicKey decodeECPublicKey(byte[] encoded) throws KeyDecodeFailedException {
		try {
<span class="fc" id="L96">			KeyFactory factory = KeyFactory.getInstance(EC_ALG);</span>
<span class="fc" id="L97">			var publicKey = factory.generatePublic(new X509EncodedKeySpec(encoded));</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">			if (publicKey instanceof ECPublicKey ecPublicKey) {</span>
<span class="fc" id="L99">				return ecPublicKey;</span>
			} else {
<span class="nc" id="L101">				throw new IllegalStateException(EC_ALG + &quot; key factory not generating ECPublicKeys&quot;);</span>
			}
<span class="nc" id="L103">		} catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L104">			throw new IllegalStateException(EC_ALG + &quot; not supported&quot;);</span>
<span class="nc" id="L105">		} catch (InvalidKeySpecException e) {</span>
<span class="nc" id="L106">			throw new KeyDecodeFailedException(e);</span>
		}
	}

	public static JWEObject encryptVaultKey(Masterkey vaultKey, ECPublicKey userKey) {
<span class="fc" id="L111">		return encryptKey(vaultKey, userKey);</span>
	}

	private static JWEObject encryptKey(Key key, ECPublicKey userKey) {
		try {
<span class="fc" id="L116">			var encodedVaultKey = Base64.getEncoder().encodeToString(key.getEncoded());</span>
<span class="fc" id="L117">			var keyGen = new ECKeyGenerator(Curve.P_384);</span>
<span class="fc" id="L118">			var ephemeralKeyPair = keyGen.generate();</span>
<span class="fc" id="L119">			var header = new JWEHeader.Builder(JWEAlgorithm.ECDH_ES, EncryptionMethod.A256GCM).ephemeralPublicKey(ephemeralKeyPair.toPublicJWK()).build();</span>
<span class="fc" id="L120">			var payload = new Payload(Map.of(JWE_PAYLOAD_KEY_FIELD, encodedVaultKey));</span>
<span class="fc" id="L121">			var jwe = new JWEObject(header, payload);</span>
<span class="fc" id="L122">			jwe.encrypt(new ECDHEncrypter(userKey));</span>
<span class="fc" id="L123">			return jwe;</span>
<span class="nc" id="L124">		} catch (JOSEException e) {</span>
<span class="nc" id="L125">			throw new RuntimeException(e);</span>
		}
	}

	public static Masterkey decryptVaultKey(JWEObject jwe, ECPrivateKey privateKey) throws InvalidJweKeyException {
		try {
<span class="fc" id="L131">			jwe.decrypt(new ECDHDecrypter(privateKey));</span>
<span class="fc" id="L132">			return readKey(jwe, JWE_PAYLOAD_KEY_FIELD, Masterkey::new);</span>
<span class="fc" id="L133">		} catch (JOSEException e) {</span>
<span class="fc" id="L134">			throw new InvalidJweKeyException(e);</span>
		}
	}

	private static &lt;T&gt; T readKey(JWEObject jwe, String keyField, Function&lt;byte[], T&gt; rawKeyFactory) throws MasterkeyLoadingFailedException {
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		Preconditions.checkArgument(jwe.getState() == JWEObject.State.DECRYPTED);</span>
<span class="fc" id="L140">		var fields = jwe.getPayload().toJSONObject();</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">		if (fields == null) {</span>
<span class="fc" id="L142">			LOG.error(&quot;Expected JWE payload to be JSON: {}&quot;, jwe.getPayload());</span>
<span class="fc" id="L143">			throw new MasterkeyLoadingFailedException(&quot;Expected JWE payload to be JSON&quot;);</span>
		}
<span class="fc" id="L145">		var keyBytes = new byte[0];</span>
		try {
<span class="fc bfc" id="L147" title="All 2 branches covered.">			if (fields.get(keyField) instanceof String key) {</span>
<span class="fc" id="L148">				keyBytes = Base64.getDecoder().decode(key);</span>
<span class="fc" id="L149">				return rawKeyFactory.apply(keyBytes);</span>
			} else {
<span class="fc" id="L151">				throw new IllegalArgumentException(&quot;JWE payload doesn't contain field &quot; + keyField);</span>
			}
<span class="fc" id="L153">		} catch (IllegalArgumentException | KeyDecodeFailedException e) {</span>
<span class="fc" id="L154">			LOG.error(&quot;Unexpected JWE payload: {}&quot;, jwe.getPayload());</span>
<span class="fc" id="L155">			throw new MasterkeyLoadingFailedException(&quot;Unexpected JWE payload&quot;, e);</span>
		} finally {
<span class="fc" id="L157">			Arrays.fill(keyBytes, (byte) 0x00);</span>
		}
	}

	public static class InvalidJweKeyException extends MasterkeyLoadingFailedException {

		public InvalidJweKeyException(Throwable cause) {
<span class="fc" id="L164">			super(&quot;Invalid key&quot;, cause);</span>
<span class="fc" id="L165">		}</span>
	}

	public static class KeyDecodeFailedException extends CryptoException {

		public KeyDecodeFailedException(Throwable cause) {
<span class="nc" id="L171">			super(&quot;Malformed key&quot;, cause);</span>
<span class="nc" id="L172">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>