<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ErrorController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.error</a> &gt; <span class="el_source">ErrorController.java</span></div><h1>ErrorController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.error;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.cryptomator.common.Environment;
import org.cryptomator.common.ErrorCode;
import org.cryptomator.common.Nullable;
import org.cryptomator.ui.common.FxController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.inject.Named;
import javafx.application.Application;
import javafx.application.Platform;
import javafx.beans.binding.BooleanExpression;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.ObjectProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.property.SimpleObjectProperty;
import javafx.fxml.FXML;
import javafx.scene.Scene;
import javafx.scene.input.Clipboard;
import javafx.scene.input.ClipboardContent;
import javafx.stage.Stage;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import java.util.Comparator;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.TimeUnit;

public class ErrorController implements FxController {

<span class="fc" id="L44">	private static final ObjectMapper JSON = new ObjectMapper();</span>
<span class="fc" id="L45">	private static final Logger LOG = LoggerFactory.getLogger(ErrorController.class);</span>
	private static final String USER_AGENT_FORMAT = &quot;Cryptomator/%s (Build %s) (%s %s %s)&quot;;
	private static final String ERROR_CODES_URL_FORMAT = &quot;https://api.cryptomator.org/desktop/error-codes.json?error-code=%s&quot;;
	private static final String SEARCH_URL_FORMAT = &quot;https://github.com/cryptomator/cryptomator/discussions/categories/errors?discussions_q=category:Errors+%s&quot;;
	private static final String REPORT_URL_FORMAT = &quot;https://github.com/cryptomator/cryptomator/discussions/new?category=Errors&amp;title=Error+%s&amp;body=%s&quot;;
	private static final String SEARCH_ERRORCODE_DELIM = &quot; OR &quot;;
	private static final String REPORT_BODY_TEMPLATE = &quot;&quot;&quot;
			&lt;!-- üíö Thank you for reporting this error. --&gt;
			OS: %s / %s
			App: %s / %s
			
			&lt;!-- ‚úè Please describe what happened as accurately as possible. --&gt;
			Description:
				
			&lt;!-- üìã Please also copy and paste the details from the error window. --&gt;
			Details:
			
			&lt;!-- ‚ùó If the description or the detail text is missing, the discussion will be deleted. --&gt;
			&quot;&quot;&quot;;

	private final Application application;
	private final String stackTrace;
	private final ErrorCode errorCode;
	private final Scene previousScene;
	private final Stage window;
	private final Environment environment;
	private final ExecutorService executorService;

<span class="fc" id="L73">	private final BooleanProperty copiedDetails = new SimpleBooleanProperty();</span>
<span class="fc" id="L74">	private final ObjectProperty&lt;ErrorDiscussion&gt; matchingErrorDiscussion = new SimpleObjectProperty&lt;&gt;();</span>
<span class="fc" id="L75">	private final BooleanExpression errorSolutionFound = matchingErrorDiscussion.isNotNull();</span>
<span class="fc" id="L76">	private final BooleanProperty isLoadingHttpResponse = new SimpleBooleanProperty();</span>
<span class="fc" id="L77">	private final BooleanProperty askedForLookupDatabasePermission = new SimpleBooleanProperty();</span>
	private final boolean formerSceneWasResizable;

	@Inject
<span class="fc" id="L81">	ErrorController(Application application, @Named(&quot;stackTrace&quot;) String stackTrace, ErrorCode errorCode, @Nullable Scene previousScene, Stage window, Environment environment, ExecutorService executorService) {</span>
<span class="fc" id="L82">		this.application = application;</span>
<span class="fc" id="L83">		this.stackTrace = stackTrace;</span>
<span class="fc" id="L84">		this.errorCode = errorCode;</span>
<span class="fc" id="L85">		this.previousScene = previousScene;</span>
<span class="fc" id="L86">		this.window = window;</span>
<span class="fc" id="L87">		this.environment = environment;</span>
<span class="fc" id="L88">		this.executorService = executorService;</span>
<span class="fc" id="L89">		this.formerSceneWasResizable = window.isResizable();</span>
<span class="fc" id="L90">	}</span>

	@FXML
	public void back() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (previousScene != null) {</span>
<span class="nc" id="L95">			window.setScene(previousScene);</span>
<span class="nc" id="L96">			window.setResizable(formerSceneWasResizable);</span>
		}
<span class="nc" id="L98">	}</span>

	@FXML
	public void close() {
<span class="nc" id="L102">		window.close();</span>
<span class="nc" id="L103">	}</span>

	@FXML
	public void showSolution() {
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (matchingErrorDiscussion.isNotNull().get()) {</span>
<span class="nc" id="L108">			var discussion = matchingErrorDiscussion.get();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if (discussion != null) {</span>
<span class="nc" id="L110">				application.getHostServices().showDocument(discussion.url);</span>
			}
		}
<span class="nc" id="L113">	}</span>

	@FXML
	public void searchError() {
<span class="nc" id="L117">		var searchTerm = URLEncoder.encode(getErrorCode().replace(ErrorCode.DELIM, SEARCH_ERRORCODE_DELIM), StandardCharsets.UTF_8);</span>
<span class="nc" id="L118">		application.getHostServices().showDocument(SEARCH_URL_FORMAT.formatted(searchTerm));</span>
<span class="nc" id="L119">	}</span>

	@FXML
	public void reportError() {
<span class="nc" id="L123">		var title = URLEncoder.encode(getErrorCode(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L124">		var enhancedTemplate = String.format(REPORT_BODY_TEMPLATE, //</span>
<span class="nc" id="L125">				System.getProperty(&quot;os.name&quot;), //</span>
<span class="nc" id="L126">				System.getProperty(&quot;os.version&quot;), //</span>
<span class="nc" id="L127">				environment.getAppVersion(), //</span>
<span class="nc" id="L128">				environment.getBuildNumber().orElse(&quot;undefined&quot;));</span>
<span class="nc" id="L129">		var body = URLEncoder.encode(enhancedTemplate, StandardCharsets.UTF_8);</span>
<span class="nc" id="L130">		application.getHostServices().showDocument(REPORT_URL_FORMAT.formatted(title, body));</span>
<span class="nc" id="L131">	}</span>

	@FXML
	public void copyDetails() {
<span class="nc" id="L135">		ClipboardContent clipboardContent = new ClipboardContent();</span>
<span class="nc" id="L136">		clipboardContent.putString(getDetailText());</span>
<span class="nc" id="L137">		Clipboard.getSystemClipboard().setContent(clipboardContent);</span>

<span class="nc" id="L139">		copiedDetails.set(true);</span>
<span class="nc" id="L140">		CompletableFuture.delayedExecutor(2, TimeUnit.SECONDS, Platform::runLater).execute(() -&gt; copiedDetails.set(false));</span>
<span class="nc" id="L141">	}</span>

	@FXML
	public void dismiss() {
<span class="nc" id="L145">		askedForLookupDatabasePermission.set(true);</span>
<span class="nc" id="L146">	}</span>

	@FXML
	public void lookUpSolution() {
<span class="nc" id="L150">		String userAgent = USER_AGENT_FORMAT.formatted( //</span>
<span class="nc" id="L151">				environment.getAppVersion(), //</span>
<span class="nc" id="L152">				environment.getBuildNumber().orElse(&quot;undefined&quot;), //</span>
<span class="nc" id="L153">				System.getProperty(&quot;os.name&quot;), //</span>
<span class="nc" id="L154">				System.getProperty(&quot;os.version&quot;), //</span>
<span class="nc" id="L155">				System.getProperty(&quot;os.arch&quot;));</span>
<span class="nc" id="L156">		isLoadingHttpResponse.set(true);</span>
<span class="nc" id="L157">		askedForLookupDatabasePermission.set(true);</span>
<span class="nc" id="L158">		HttpClient httpClient = HttpClient.newBuilder().version(HttpClient.Version.HTTP_1_1).build();</span>
<span class="nc" id="L159">		HttpRequest httpRequest = HttpRequest.newBuilder()//</span>
<span class="nc" id="L160">				.header(&quot;User-Agent&quot;, userAgent)</span>
<span class="nc" id="L161">				.timeout(Duration.ofSeconds(10))</span>
<span class="nc" id="L162">				.uri(URI.create(ERROR_CODES_URL_FORMAT.formatted(URLEncoder.encode(errorCode.toString(),StandardCharsets.UTF_8))))//</span>
<span class="nc" id="L163">				.build();</span>
<span class="nc" id="L164">		httpClient.sendAsync(httpRequest, HttpResponse.BodyHandlers.ofInputStream())//</span>
<span class="nc" id="L165">				.thenAcceptAsync(this::loadHttpResponse, executorService)//</span>
<span class="nc" id="L166">				.whenCompleteAsync((r, e) -&gt; isLoadingHttpResponse.set(false), Platform::runLater);</span>
<span class="nc" id="L167">	}</span>

	private void loadHttpResponse(HttpResponse&lt;InputStream&gt; response) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (response.statusCode() != 200) {</span>
<span class="nc" id="L171">			LOG.error(&quot;Status code {} when trying to load {} &quot;, response.statusCode(), response.uri());</span>
		}
		try {
<span class="nc" id="L174">			var typeRef = new TypeReference&lt;Map&lt;String, ErrorDiscussion&gt;&gt;() {};</span>
<span class="nc" id="L175">			Map&lt;String, ErrorDiscussion&gt; errorDiscussionMap = JSON.reader().forType(typeRef).readValue(response.body());</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">			if (errorDiscussionMap.values().stream().anyMatch(this::containsMethodCode)) {</span>
<span class="nc" id="L178">				Comparator&lt;ErrorDiscussion&gt; comp = this::compareByFullErrorCode;</span>
<span class="nc" id="L179">				Optional&lt;ErrorDiscussion&gt; value = errorDiscussionMap.values().stream().filter(this::containsMethodCode)//</span>
<span class="nc" id="L180">						.min(comp//</span>
<span class="nc" id="L181">								.thenComparing(this::compareByRootCauseCode)//</span>
<span class="nc" id="L182">								.thenComparing(this::compareIsAnswered)//</span>
<span class="nc" id="L183">								.thenComparing(this::compareUpvoteCount));</span>

<span class="nc bnc" id="L185" title="All 2 branches missed.">				if (value.isPresent()) {</span>
<span class="nc" id="L186">					matchingErrorDiscussion.set(value.get());</span>
				}
			}
<span class="nc" id="L189">		} catch (IOException e) {</span>
<span class="nc" id="L190">			LOG.error(&quot;Failed to load or parse JSON from &quot; + response.uri(), e);</span>
<span class="nc" id="L191">		}</span>
<span class="nc" id="L192">	}</span>

	/**
	 * Checks if an ErrorDiscussion object's title contains the error code's method code.
	 *
	 * @param errorDiscussion The ErrorDiscussion object to be checked.
	 * @return A boolean value indicating if the ErrorDiscussion object's title contains the error code's method code:
	 * - true if the title contains the method code,
	 * - false otherwise.
	 */
	public boolean containsMethodCode(ErrorDiscussion errorDiscussion) {
<span class="fc" id="L203">		return errorDiscussion.title.contains(&quot; &quot; + errorCode.methodCode());</span>
	}

	/**
	 * Compares two ErrorDiscussion objects based on their upvote counts and returns the result.
	 *
	 * @param ed1 The first ErrorDiscussion object.
	 * @param ed2 The second ErrorDiscussion object.
	 * @return An integer indicating which ErrorDiscussion object has a higher upvote count:
	 * - A positive value if ed2 has a higher upvote count than ed1,
	 * - A negative value if ed1 has a higher upvote count than ed2,
	 * - Or 0 if both upvote counts are equal.
	 */
	public int compareUpvoteCount(ErrorDiscussion ed1, ErrorDiscussion ed2) {
<span class="fc" id="L217">		return Integer.compare(ed2.upvoteCount, ed1.upvoteCount);</span>
	}

	/**
	 * Compares two ErrorDiscussion objects based on their answered status and returns the result.
	 *
	 * @param ed1 The first ErrorDiscussion object.
	 * @param ed2 The second ErrorDiscussion object.
	 * @return An integer indicating the answered status of the ErrorDiscussion objects:
	 * - A negative value (-1) if ed1 is considered answered and ed2 is considered unanswered,
	 * - A positive value (1) if ed1 is considered unanswered and ed2 is considered answered,
	 * - Or 0 if both ErrorDiscussion objects are considered answered or unanswered.
	 */
	public int compareIsAnswered(ErrorDiscussion ed1, ErrorDiscussion ed2) {
<span class="fc bfc" id="L231" title="All 4 branches covered.">		if (ed1.answer != null &amp;&amp; ed2.answer == null) {</span>
<span class="fc" id="L232">			return -1;</span>
<span class="fc bfc" id="L233" title="All 4 branches covered.">		} else if (ed1.answer == null &amp;&amp; ed2.answer != null) {</span>
<span class="fc" id="L234">			return 1;</span>
		} else {
<span class="fc" id="L236">			return 0;</span>
		}
	}

	/**
	 * Compares two ErrorDiscussion objects based on the presence of the full error code in their titles and returns the result.
	 *
	 * @param ed1 The first ErrorDiscussion object.
	 * @param ed2 The second ErrorDiscussion object.
	 * @return An integer indicating the comparison result based on the presence of the full error code in the titles:
	 * - A negative value (-1) if ed1 contains the full error code in the title and ed2 does not have a match,
	 * - A positive value (1) if ed1 does not have a match and ed2 contains the full error code in the title,
	 * - Or 0 if both ErrorDiscussion objects either contain the full error code or do not have a match in the titles.
	 */
	public int compareByFullErrorCode(ErrorDiscussion ed1, ErrorDiscussion ed2) {
<span class="pc bpc" id="L251" title="1 of 4 branches missed.">		if (ed1.title.contains(getErrorCode()) &amp;&amp; !ed2.title.contains(getErrorCode())) {</span>
<span class="fc" id="L252">			return -1;</span>
<span class="pc bpc" id="L253" title="1 of 4 branches missed.">		} else if (!ed1.title.contains(getErrorCode()) &amp;&amp; ed2.title.contains(getErrorCode())) {</span>
<span class="fc" id="L254">			return 1;</span>
		} else {
<span class="fc" id="L256">			return 0;</span>
		}
	}

	/**
	 * Compares two ErrorDiscussion objects based on the presence of the root cause code in their titles and returns the result.
	 *
	 * @param ed1 The first ErrorDiscussion object.
	 * @param ed2 The second ErrorDiscussion object.
	 * @return An integer indicating the comparison result based on the presence of the root cause code in the titles:
	 * - A negative value (-1) if ed1 contains the root cause code in the title and ed2 does not have a match,
	 * - A positive value (1) if ed1 does not have a match and ed2 contains the root cause code in the title,
	 * - Or 0 if both ErrorDiscussion objects either contain the root cause code or do not have a match in the titles.
	 */
	public int compareByRootCauseCode(ErrorDiscussion ed1, ErrorDiscussion ed2) {
<span class="fc" id="L271">		String value = &quot; &quot; + errorCode.methodCode() + ErrorCode.DELIM + errorCode.rootCauseCode();</span>
<span class="fc bfc" id="L272" title="All 4 branches covered.">		if (ed1.title.contains(value) &amp;&amp; !ed2.title.contains(value)) {</span>
<span class="fc" id="L273">			return -1;</span>
<span class="fc bfc" id="L274" title="All 4 branches covered.">		} else if (!ed1.title.contains(value) &amp;&amp; ed2.title.contains(value)) {</span>
<span class="fc" id="L275">			return 1;</span>
		} else {
<span class="fc" id="L277">			return 0;</span>
		}
	}

	/* Getter/Setter */
	public boolean isPreviousScenePresent() {
<span class="nc bnc" id="L283" title="All 2 branches missed.">		return previousScene != null;</span>
	}

	public String getStackTrace() {
<span class="nc" id="L287">		return stackTrace;</span>
	}

	public String getErrorCode() {
<span class="fc" id="L291">		return errorCode.toString();</span>
	}

	public String getDetailText() {
<span class="nc" id="L295">		return &quot;```\nError Code &quot; + getErrorCode() + &quot;\n&quot; + getStackTrace() + &quot;\n```&quot;;</span>
	}

	public BooleanProperty copiedDetailsProperty() {
<span class="nc" id="L299">		return copiedDetails;</span>
	}

	public boolean getCopiedDetails() {
<span class="nc" id="L303">		return copiedDetails.get();</span>
	}

	public BooleanExpression errorSolutionFoundProperty() {
<span class="nc" id="L307">		return errorSolutionFound;</span>
	}

	public boolean getErrorSolutionFound() {
<span class="nc" id="L311">		return errorSolutionFound.get();</span>
	}

	public BooleanProperty isLoadingHttpResponseProperty() {
<span class="nc" id="L315">		return isLoadingHttpResponse;</span>
	}

	public boolean getIsLoadingHttpResponse() {
<span class="nc" id="L319">		return isLoadingHttpResponse.get();</span>
	}

	public BooleanProperty askedForLookupDatabasePermissionProperty() {
<span class="nc" id="L323">		return askedForLookupDatabasePermission;</span>
	}

	public boolean getAskedForLookupDatabasePermission() {
<span class="nc" id="L327">		return askedForLookupDatabasePermission.get();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>