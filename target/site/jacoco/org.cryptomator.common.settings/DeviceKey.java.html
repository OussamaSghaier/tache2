<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeviceKey.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.common.settings</a> &gt; <span class="el_source">DeviceKey.java</span></div><h1>DeviceKey.java</h1><pre class="source lang-java linenums">package org.cryptomator.common.settings;

import com.google.common.base.Preconditions;
import com.google.common.base.Suppliers;
import org.cryptomator.common.Environment;
import org.cryptomator.common.keychain.KeychainManager;
import org.cryptomator.cryptolib.common.P384KeyPair;
import org.cryptomator.cryptolib.common.Pkcs12Exception;
import org.cryptomator.integrations.keychain.KeychainAccessException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.inject.Singleton;
import java.io.IOException;
import java.nio.CharBuffer;
import java.nio.file.Files;
import java.nio.file.Path;
import java.security.SecureRandom;
import java.util.Arrays;
import java.util.UUID;
import java.util.function.Supplier;

@Singleton
public class DeviceKey {

<span class="nc" id="L27">	private static final Logger LOG = LoggerFactory.getLogger(DeviceKey.class);</span>
	private static final String KEYCHAIN_KEY = &quot;cryptomator-device-p12&quot;;
	private static final String KEYCHAIN_DISPLAY_NAME = &quot;Cryptomator Device Keypair .p12 Passphrase&quot;;

	private final KeychainManager keychainManager;
	private final Environment env;
	private final SecureRandom csprng;
	private final Supplier&lt;P384KeyPair&gt; keyPairSupplier;

	@Inject
<span class="nc" id="L37">	public DeviceKey(KeychainManager keychainManager, Environment env, SecureRandom csprng) {</span>
<span class="nc" id="L38">		this.keychainManager = keychainManager;</span>
<span class="nc" id="L39">		this.env = env;</span>
<span class="nc" id="L40">		this.csprng = csprng;</span>
<span class="nc" id="L41">		this.keyPairSupplier = Suppliers.memoize(this::loadOrCreate);</span>
<span class="nc" id="L42">	}</span>

	public P384KeyPair get() throws DeviceKeyRetrievalException {
<span class="nc" id="L45">		Preconditions.checkState(keychainManager.isSupported());</span>
<span class="nc" id="L46">		return keyPairSupplier.get();</span>
	}

	private P384KeyPair loadOrCreate() throws DeviceKeyRetrievalException {
<span class="nc" id="L50">		Path p12File = env.getP12Path().findFirst().orElseThrow(() -&gt; new DeviceKeyRetrievalException(&quot;No path for .p12 file configured&quot;));</span>
<span class="nc" id="L51">		char[] passphrase = null;</span>
		try {
<span class="nc" id="L53">			passphrase = keychainManager.loadPassphrase(KEYCHAIN_KEY);</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">			if (passphrase != null &amp;&amp; Files.isRegularFile(p12File)) {</span>
<span class="nc" id="L55">				return loadExistingKeyPair(passphrase, p12File);</span>
			} else { // (re)generate new key pair if either file or password got lost
<span class="nc" id="L57">				passphrase = randomPassword();</span>
<span class="nc" id="L58">				keychainManager.storePassphrase(KEYCHAIN_KEY, KEYCHAIN_DISPLAY_NAME, CharBuffer.wrap(passphrase));</span>
<span class="nc" id="L59">				return createAndStoreNewKeyPair(passphrase, p12File);</span>
			}
<span class="nc" id="L61">		} catch (KeychainAccessException e) {</span>
<span class="nc" id="L62">			throw new DeviceKeyRetrievalException(&quot;Failed to access system keychain&quot;, e);</span>
<span class="nc" id="L63">		} catch (Pkcs12Exception | IOException e) {</span>
<span class="nc" id="L64">			throw new DeviceKeyRetrievalException(&quot;Failed to access .p12 file&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L66" title="All 2 branches missed.">			if (passphrase != null) {</span>
<span class="nc" id="L67">				Arrays.fill(passphrase, '\0');</span>
			}
		}
	}

	private P384KeyPair loadExistingKeyPair(char[] passphrase, Path p12File) throws IOException {
<span class="nc" id="L73">		LOG.debug(&quot;Loading existing device key from {}&quot;, p12File);</span>
<span class="nc" id="L74">		return P384KeyPair.load(p12File, passphrase);</span>
	}

	private P384KeyPair createAndStoreNewKeyPair(char[] passphrase, Path p12File) throws IOException {
<span class="nc" id="L78">		var keyPair = P384KeyPair.generate();</span>
<span class="nc" id="L79">		var tmpFile = p12File.resolveSibling(p12File.getFileName().toString() + &quot;.tmp&quot;);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">		if(Files.exists(tmpFile)) {</span>
<span class="nc" id="L81">			LOG.debug(&quot;Leftover from devicekey creation detected. Deleting {}&quot;, tmpFile);</span>
<span class="nc" id="L82">			Files.delete(tmpFile);</span>
		}
<span class="nc" id="L84">		LOG.debug(&quot;Store new device key to {}&quot;, p12File);</span>
<span class="nc" id="L85">		keyPair.store(p12File, passphrase);</span>
<span class="nc" id="L86">		return keyPair;</span>
	}

	private char[] randomPassword() {
		// this is a fast &amp; easy attempt to create a random string:
<span class="nc" id="L91">		var uuid = new UUID(csprng.nextLong(), csprng.nextLong());</span>
<span class="nc" id="L92">		return uuid.toString().toCharArray();</span>
	}

	public static class DeviceKeyRetrievalException extends RuntimeException {
		private DeviceKeyRetrievalException(String message) {
<span class="nc" id="L97">			super(message);</span>
<span class="nc" id="L98">		}</span>
		private DeviceKeyRetrievalException(String message, Throwable cause) {
<span class="nc" id="L100">			super(message, cause);</span>
<span class="nc" id="L101">		}</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>