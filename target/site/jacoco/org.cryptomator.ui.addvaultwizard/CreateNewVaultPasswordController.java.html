<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreateNewVaultPasswordController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cryptomator Desktop App</a> &gt; <a href="index.source.html" class="el_package">org.cryptomator.ui.addvaultwizard</a> &gt; <span class="el_source">CreateNewVaultPasswordController.java</span></div><h1>CreateNewVaultPasswordController.java</h1><pre class="source lang-java linenums">package org.cryptomator.ui.addvaultwizard;

import dagger.Lazy;
import org.cryptomator.common.vaults.Vault;
import org.cryptomator.common.vaults.VaultListManager;
import org.cryptomator.cryptofs.CryptoFileSystemProperties;
import org.cryptomator.cryptofs.CryptoFileSystemProvider;
import org.cryptomator.cryptolib.api.CryptoException;
import org.cryptomator.cryptolib.api.CryptorProvider;
import org.cryptomator.cryptolib.api.Masterkey;
import org.cryptomator.cryptolib.api.MasterkeyLoader;
import org.cryptomator.cryptolib.common.MasterkeyFileAccess;
import org.cryptomator.ui.changepassword.NewPasswordController;
import org.cryptomator.ui.common.FxController;
import org.cryptomator.ui.common.FxmlFile;
import org.cryptomator.ui.common.FxmlScene;
import org.cryptomator.ui.common.Tasks;
import org.cryptomator.ui.fxapp.FxApplicationWindows;
import org.cryptomator.ui.recoverykey.RecoveryKeyFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.inject.Named;
import javafx.beans.binding.Bindings;
import javafx.beans.binding.ObjectBinding;
import javafx.beans.property.BooleanProperty;
import javafx.beans.property.IntegerProperty;
import javafx.beans.property.ObjectProperty;
import javafx.beans.property.SimpleBooleanProperty;
import javafx.beans.property.StringProperty;
import javafx.fxml.FXML;
import javafx.scene.Scene;
import javafx.scene.control.ContentDisplay;
import javafx.scene.control.Toggle;
import javafx.scene.control.ToggleGroup;
import javafx.stage.Stage;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.channels.WritableByteChannel;
import java.nio.file.FileSystem;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.security.SecureRandom;
import java.util.ResourceBundle;
import java.util.concurrent.ExecutorService;

import static java.nio.charset.StandardCharsets.US_ASCII;
import static org.cryptomator.common.Constants.DEFAULT_KEY_ID;
import static org.cryptomator.common.Constants.MASTERKEY_FILENAME;

@AddVaultWizardScoped
public class CreateNewVaultPasswordController implements FxController {

<span class="nc" id="L56">	private static final Logger LOG = LoggerFactory.getLogger(CreateNewVaultPasswordController.class);</span>

	private final Stage window;
	private final Lazy&lt;Scene&gt; chooseExpertSettingsScene;
	private final Lazy&lt;Scene&gt; recoveryKeyScene;
	private final Lazy&lt;Scene&gt; successScene;
	private final FxApplicationWindows appWindows;
	private final ExecutorService executor;
	private final RecoveryKeyFactory recoveryKeyFactory;
	private final StringProperty vaultNameProperty;
	private final ObjectProperty&lt;Path&gt; vaultPathProperty;
	private final ObjectProperty&lt;Vault&gt; vaultProperty;
	private final StringProperty recoveryKeyProperty;
	private final VaultListManager vaultListManager;
	private final ResourceBundle resourceBundle;
	private final ReadmeGenerator readmeGenerator;
	private final SecureRandom csprng;
	private final MasterkeyFileAccess masterkeyFileAccess;
	private final BooleanProperty processing;
	private final BooleanProperty readyToCreateVault;
	private final ObjectBinding&lt;ContentDisplay&gt; createVaultButtonState;
	private final IntegerProperty shorteningThreshold;

	/* FXML */
	public ToggleGroup recoveryKeyChoice;
	public Toggle showRecoveryKey;
	public Toggle skipRecoveryKey;
	public NewPasswordController newPasswordSceneController;

	@Inject
	CreateNewVaultPasswordController(@AddVaultWizardWindow Stage window, //
									 @FxmlScene(FxmlFile.ADDVAULT_NEW_EXPERT_SETTINGS) Lazy&lt;Scene&gt; chooseExpertSettingsScene, //
									 @FxmlScene(FxmlFile.ADDVAULT_NEW_RECOVERYKEY) Lazy&lt;Scene&gt; recoveryKeyScene, //
									 @FxmlScene(FxmlFile.ADDVAULT_SUCCESS) Lazy&lt;Scene&gt; successScene, //
									 FxApplicationWindows appWindows, //
									 ExecutorService executor, //
									 RecoveryKeyFactory recoveryKeyFactory, //
									 @Named(&quot;vaultName&quot;) StringProperty vaultName, //
									 ObjectProperty&lt;Path&gt; vaultPath, //
									 @AddVaultWizardWindow ObjectProperty&lt;Vault&gt; vault, //
									 @Named(&quot;recoveryKey&quot;) StringProperty recoveryKey, //
									 VaultListManager vaultListManager, //
									 ResourceBundle resourceBundle, //
									 @Named(&quot;shorteningThreshold&quot;) IntegerProperty shorteningThreshold, //
									 ReadmeGenerator readmeGenerator, //
									 SecureRandom csprng, //
<span class="nc" id="L102">									 MasterkeyFileAccess masterkeyFileAccess) {</span>
<span class="nc" id="L103">		this.window = window;</span>
<span class="nc" id="L104">		this.chooseExpertSettingsScene = chooseExpertSettingsScene;</span>
<span class="nc" id="L105">		this.recoveryKeyScene = recoveryKeyScene;</span>
<span class="nc" id="L106">		this.successScene = successScene;</span>
<span class="nc" id="L107">		this.appWindows = appWindows;</span>
<span class="nc" id="L108">		this.executor = executor;</span>
<span class="nc" id="L109">		this.recoveryKeyFactory = recoveryKeyFactory;</span>
<span class="nc" id="L110">		this.vaultNameProperty = vaultName;</span>
<span class="nc" id="L111">		this.vaultPathProperty = vaultPath;</span>
<span class="nc" id="L112">		this.vaultProperty = vault;</span>
<span class="nc" id="L113">		this.recoveryKeyProperty = recoveryKey;</span>
<span class="nc" id="L114">		this.vaultListManager = vaultListManager;</span>
<span class="nc" id="L115">		this.resourceBundle = resourceBundle;</span>
<span class="nc" id="L116">		this.readmeGenerator = readmeGenerator;</span>
<span class="nc" id="L117">		this.csprng = csprng;</span>
<span class="nc" id="L118">		this.masterkeyFileAccess = masterkeyFileAccess;</span>
<span class="nc" id="L119">		this.processing = new SimpleBooleanProperty();</span>
<span class="nc" id="L120">		this.readyToCreateVault = new SimpleBooleanProperty();</span>
<span class="nc" id="L121">		this.createVaultButtonState = Bindings.when(processing).then(ContentDisplay.LEFT).otherwise(ContentDisplay.TEXT_ONLY);</span>
<span class="nc" id="L122">		this.shorteningThreshold = shorteningThreshold;</span>
<span class="nc" id="L123">	}</span>

	@FXML
	public void initialize() {
<span class="nc" id="L127">		readyToCreateVault.bind(newPasswordSceneController.goodPasswordProperty().and(recoveryKeyChoice.selectedToggleProperty().isNotNull()).and(processing.not()));</span>
<span class="nc" id="L128">		window.setOnHiding(event -&gt; {</span>
<span class="nc" id="L129">			newPasswordSceneController.passwordField.wipe();</span>
<span class="nc" id="L130">			newPasswordSceneController.reenterField.wipe();</span>
<span class="nc" id="L131">		});</span>
<span class="nc" id="L132">	}</span>

	@FXML
	public void back() {
<span class="nc" id="L136">		window.setScene(chooseExpertSettingsScene.get());</span>
<span class="nc" id="L137">	}</span>

	@FXML
	public void next() {
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (showRecoveryKey.equals(recoveryKeyChoice.getSelectedToggle())) {</span>
<span class="nc" id="L142">			showRecoveryKeyScene();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		} else if (skipRecoveryKey.equals(recoveryKeyChoice.getSelectedToggle())) {</span>
<span class="nc" id="L144">			showSuccessScene();</span>
		} else {
<span class="nc" id="L146">			throw new IllegalStateException(&quot;Unexpected toggle state&quot;);</span>
		}
<span class="nc" id="L148">	}</span>

	private void showRecoveryKeyScene() {
<span class="nc" id="L151">		Path pathToVault = vaultPathProperty.get();</span>
<span class="nc" id="L152">		processing.set(true);</span>
<span class="nc" id="L153">		Tasks.create(() -&gt; {</span>
<span class="nc" id="L154">			createVault(pathToVault);</span>
<span class="nc" id="L155">			return recoveryKeyFactory.createRecoveryKey(pathToVault, newPasswordSceneController.passwordField.getCharacters());</span>
<span class="nc" id="L156">		}).onSuccess(recoveryKey -&gt; {</span>
<span class="nc" id="L157">			creationSucceeded(pathToVault);</span>
<span class="nc" id="L158">			recoveryKeyProperty.set(recoveryKey);</span>
<span class="nc" id="L159">			window.setScene(recoveryKeyScene.get());</span>
<span class="nc" id="L160">		}).onError(IOException.class, e -&gt; {</span>
<span class="nc" id="L161">			LOG.error(&quot;Failed to create vault.&quot;, e);</span>
<span class="nc" id="L162">			appWindows.showErrorWindow(e, window, window.getScene());</span>
<span class="nc" id="L163">		}).andFinally(() -&gt; {</span>
<span class="nc" id="L164">			processing.set(false);</span>
<span class="nc" id="L165">		}).runOnce(executor);</span>
<span class="nc" id="L166">	}</span>

	private void showSuccessScene() {
<span class="nc" id="L169">		Path pathToVault = vaultPathProperty.get();</span>
<span class="nc" id="L170">		processing.set(true);</span>
<span class="nc" id="L171">		Tasks.create(() -&gt; {</span>
<span class="nc" id="L172">			createVault(pathToVault);</span>
<span class="nc" id="L173">		}).onSuccess(() -&gt; {</span>
<span class="nc" id="L174">			creationSucceeded(pathToVault);</span>
<span class="nc" id="L175">			window.setScene(successScene.get());</span>
<span class="nc" id="L176">		}).onError(IOException.class, e -&gt; {</span>
<span class="nc" id="L177">			LOG.error(&quot;Failed to create vault.&quot;, e);</span>
<span class="nc" id="L178">			appWindows.showErrorWindow(e, window, window.getScene());</span>
<span class="nc" id="L179">		}).andFinally(() -&gt; {</span>
<span class="nc" id="L180">			processing.set(false);</span>
<span class="nc" id="L181">		}).runOnce(executor);</span>
<span class="nc" id="L182">	}</span>

	private void createVault(Path path) throws IOException {
		// 0. create directory
<span class="nc" id="L186">		Files.createDirectory(path);</span>

		// 1. write masterkey:
<span class="nc" id="L189">		Path masterkeyFilePath = path.resolve(MASTERKEY_FILENAME);</span>
<span class="nc" id="L190">		try (Masterkey masterkey = Masterkey.generate(csprng)) {</span>
<span class="nc" id="L191">			masterkeyFileAccess.persist(masterkey, masterkeyFilePath, newPasswordSceneController.passwordField.getCharacters());</span>

			// 2. initialize vault:
			try {
<span class="nc" id="L195">				MasterkeyLoader loader = ignored -&gt; masterkey.copy();</span>
<span class="nc" id="L196">				CryptoFileSystemProperties fsProps = CryptoFileSystemProperties.cryptoFileSystemProperties() //</span>
<span class="nc" id="L197">						.withCipherCombo(CryptorProvider.Scheme.SIV_GCM) //</span>
<span class="nc" id="L198">						.withKeyLoader(loader) //</span>
<span class="nc" id="L199">						.withShorteningThreshold(shorteningThreshold.get()) //</span>
<span class="nc" id="L200">						.build();</span>
<span class="nc" id="L201">				CryptoFileSystemProvider.initialize(path, fsProps, DEFAULT_KEY_ID);</span>

				// 3. write vault-internal readme file:
<span class="nc" id="L204">				String vaultReadmeFileName = resourceBundle.getString(&quot;addvault.new.readme.accessLocation.fileName&quot;);</span>
<span class="nc" id="L205">				try (FileSystem fs = CryptoFileSystemProvider.newFileSystem(path, fsProps); //</span>
<span class="nc" id="L206">					 WritableByteChannel ch = Files.newByteChannel(fs.getPath(&quot;/&quot;, vaultReadmeFileName), StandardOpenOption.CREATE_NEW, StandardOpenOption.WRITE)) {</span>
<span class="nc" id="L207">					ch.write(US_ASCII.encode(readmeGenerator.createVaultAccessLocationReadmeRtf()));</span>
				}
<span class="nc" id="L209">			} catch (CryptoException e) {</span>
<span class="nc" id="L210">				throw new IOException(&quot;Vault initialization failed&quot;, e);</span>
<span class="nc" id="L211">			}</span>
		}

		// 4. write vault-external readme file:
<span class="nc" id="L215">		String storagePathReadmeFileName = resourceBundle.getString(&quot;addvault.new.readme.storageLocation.fileName&quot;);</span>
<span class="nc" id="L216">		try (WritableByteChannel ch = Files.newByteChannel(path.resolve(storagePathReadmeFileName), StandardOpenOption.CREATE_NEW, StandardOpenOption.WRITE)) {</span>
<span class="nc" id="L217">			ch.write(US_ASCII.encode(readmeGenerator.createVaultStorageLocationReadmeRtf()));</span>
		}

<span class="nc" id="L220">		LOG.info(&quot;Created vault at {}&quot;, path);</span>
<span class="nc" id="L221">	}</span>

	private void creationSucceeded(Path pathToVault) {
		try {
<span class="nc" id="L225">			Vault newVault = vaultListManager.add(pathToVault);</span>
<span class="nc" id="L226">			vaultProperty.set(newVault);</span>
<span class="nc" id="L227">		} catch (IOException e) {</span>
<span class="nc" id="L228">			throw new UncheckedIOException(e);</span>
<span class="nc" id="L229">		}</span>
<span class="nc" id="L230">	}</span>

	/* Getter/Setter */

	public String getVaultName() {
<span class="nc" id="L235">		return vaultNameProperty.get();</span>
	}

	public StringProperty vaultNameProperty() {
<span class="nc" id="L239">		return vaultNameProperty;</span>
	}

	public BooleanProperty readyToCreateVaultProperty() {
<span class="nc" id="L243">		return readyToCreateVault;</span>
	}

	public boolean isReadyToCreateVault() {
<span class="nc" id="L247">		return readyToCreateVault.get();</span>
	}

	public ObjectBinding&lt;ContentDisplay&gt; createVaultButtonStateProperty() {
<span class="nc" id="L251">		return createVaultButtonState;</span>
	}

	public ContentDisplay getCreateVaultButtonState() {
<span class="nc" id="L255">		return createVaultButtonState.get();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>